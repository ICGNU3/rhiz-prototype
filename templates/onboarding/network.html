{% extends "base_minimal.html" %}

{% block title %}Network Mapping - Rhiz{% endblock %}

{% block content %}
<div class="min-vh-100 d-flex align-items-center justify-content-center" style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); position: relative; overflow: hidden;">
    <!-- Background Orbs -->
    <div class="background-orb"></div>
    <div class="background-orb" style="animation-delay: -2s; top: 60%; left: 80%; width: 400px; height: 400px;"></div>
    <div class="background-orb" style="animation-delay: -4s; top: 20%; left: 60%; width: 300px; height: 300px;"></div>

    <div class="container-fluid py-5">
        <div class="row justify-content-center">
            <div class="col-xl-10 col-lg-11">
                <div class="glass-card p-5">
                    <!-- Header -->
                    <div class="text-center mb-5">
                        <div class="mb-4">
                            <i class="bi bi-diagram-3 text-primary mb-3" style="font-size: 3rem;"></i>
                            <h1 class="display-5 fw-bold text-gradient mb-3">Build Your Living Network</h1>
                            <p class="lead text-light mb-0">Transform your contact list into intelligent relationship insights</p>
                        </div>
                        
                        <!-- Progress indicator -->
                        <div class="progress-container mb-4">
                            <div class="progress" style="height: 8px; background: rgba(255,255,255,0.1);">
                                <div class="progress-bar bg-gradient-primary" style="width: 66%; transition: width 0.5s ease;"></div>
                            </div>
                            <small class="text-muted mt-2 d-block">Step 3 of 4: Network Mapping</small>
                        </div>
                    </div>

                    <!-- Main Content Sections -->
                    <div id="networkContent">
                        
                        <!-- 1. Contact Import Section -->
                        <div id="importSection" class="section-panel active">
                            <div class="row">
                                <div class="col-lg-8 mx-auto">
                                    <div class="text-center mb-4">
                                        <h3 class="text-primary">Import Your Contacts</h3>
                                        <p class="text-light">Choose your preferred method to import existing contacts</p>
                                    </div>
                                    
                                    <div class="import-grid">
                                        <!-- Google Contacts -->
                                        <div class="import-option" data-source="google">
                                            <div class="import-icon">
                                                <i class="bi bi-google text-danger"></i>
                                            </div>
                                            <h5>Google Contacts</h5>
                                            <p class="text-muted">Secure OAuth integration</p>
                                            <div class="import-status d-none">
                                                <div class="spinner-border spinner-border-sm text-primary"></div>
                                                <span>Connecting...</span>
                                            </div>
                                        </div>

                                        <!-- LinkedIn -->
                                        <div class="import-option" data-source="linkedin">
                                            <div class="import-icon">
                                                <i class="bi bi-linkedin text-primary"></i>
                                            </div>
                                            <h5>LinkedIn</h5>
                                            <p class="text-muted">Smart scraper + CSV upload</p>
                                        </div>

                                        <!-- Apple/iCloud -->
                                        <div class="import-option" data-source="apple">
                                            <div class="import-icon">
                                                <i class="bi bi-apple text-light"></i>
                                            </div>
                                            <h5>Apple/iCloud</h5>
                                            <p class="text-muted">CSV export upload</p>
                                        </div>

                                        <!-- Twitter/X -->
                                        <div class="import-option" data-source="twitter">
                                            <div class="import-icon">
                                                <i class="bi bi-twitter-x text-light"></i>
                                            </div>
                                            <h5>Twitter/X</h5>
                                            <p class="text-muted">@handle input</p>
                                            <small class="text-warning">Coming soon</small>
                                        </div>

                                        <!-- Manual Add -->
                                        <div class="import-option" data-source="manual">
                                            <div class="import-icon">
                                                <i class="bi bi-person-plus text-success"></i>
                                            </div>
                                            <h5>Manual Add</h5>
                                            <p class="text-muted">Add contacts one by one</p>
                                        </div>

                                        <!-- Skip -->
                                        <div class="import-option" data-source="skip">
                                            <div class="import-icon">
                                                <i class="bi bi-arrow-right text-secondary"></i>
                                            </div>
                                            <h5>Skip for Now</h5>
                                            <p class="text-muted">Continue without importing</p>
                                        </div>
                                    </div>

                                    <!-- Progress Bar for Import -->
                                    <div id="importProgress" class="d-none mt-4">
                                        <div class="progress mb-3" style="height: 20px;">
                                            <div class="progress-bar bg-gradient-primary progress-bar-striped progress-bar-animated" 
                                                 style="width: 0%"></div>
                                        </div>
                                        <div class="text-center">
                                            <div class="fw-bold" id="importProgressText">Starting import...</div>
                                            <small class="text-muted" id="importProgressDetails">Please wait while we process your contacts</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. Contact Classification -->
                        <div id="classificationSection" class="section-panel d-none">
                            <div class="text-center mb-4">
                                <h3 class="text-primary">Classify Your Relationships</h3>
                                <p class="text-light">Help us understand your network by tagging relationship types</p>
                            </div>

                            <!-- Batch Actions -->
                            <div class="batch-actions mb-4">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="selectAll">
                                            <label class="form-check-label text-light" for="selectAll">
                                                Select All (<span id="contactCount">0</span> contacts)
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <div class="btn-group">
                                            <button class="btn btn-outline-primary btn-sm" onclick="batchTag('friend')">
                                                <i class="bi bi-heart me-1"></i>Tag as Friends
                                            </button>
                                            <button class="btn btn-outline-success btn-sm" onclick="batchTag('professional')">
                                                <i class="bi bi-briefcase me-1"></i>Professional
                                            </button>
                                            <button class="btn btn-outline-warning btn-sm" onclick="batchTag('investor')">
                                                <i class="bi bi-currency-dollar me-1"></i>Investors
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Contact Grid -->
                            <div id="contactGrid" class="contact-grid">
                                <!-- Contacts will be loaded here -->
                            </div>

                            <!-- Continue Button -->
                            <div class="text-center mt-4">
                                <button class="btn btn-primary btn-lg" onclick="continueToEnrichment()">
                                    Continue to Enrichment <i class="bi bi-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>

                        <!-- 3. Unknown But Important Mode -->
                        <div id="unknownSection" class="section-panel d-none">
                            <div class="text-center mb-4">
                                <h3 class="text-warning">Unknown But Important</h3>
                                <p class="text-light">Review contacts that might be significant but lack clear classification</p>
                            </div>

                            <div id="unknownContactsContainer">
                                <!-- Unknown contacts will be loaded here -->
                            </div>
                        </div>

                        <!-- 4. Relationship Enrichment Panel -->
                        <div id="enrichmentSection" class="section-panel d-none">
                            <div class="row">
                                <div class="col-lg-8">
                                    <h3 class="text-primary mb-4">Enrich Your Relationships</h3>
                                    <div id="enrichmentContactList">
                                        <!-- Contact list for enrichment -->
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="enrichment-sidebar glass-card p-4">
                                        <h5 class="text-primary mb-3">Relationship Details</h5>
                                        <div id="enrichmentForm" class="d-none">
                                            <!-- Enrichment form will be loaded here -->
                                        </div>
                                        <div id="enrichmentPlaceholder" class="text-center text-muted">
                                            <i class="bi bi-arrow-left me-2"></i>
                                            Select a contact to add details
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 5. Trust Calibration -->
                        <div id="trustSection" class="section-panel d-none">
                            <div class="text-center mb-4">
                                <h3 class="text-info">Trust Calibration</h3>
                                <p class="text-light">Rate your trust level for key relationships</p>
                            </div>

                            <div id="trustContactList">
                                <!-- Trust calibration contacts -->
                            </div>
                        </div>

                        <!-- 6. Auto-Sync Setup -->
                        <div id="syncSetupSection" class="section-panel d-none">
                            <div class="text-center mb-4">
                                <h3 class="text-success">Keep Your Network Updated</h3>
                                <p class="text-light">Enable automatic synchronization to keep your relationships current</p>
                            </div>

                            <div class="row justify-content-center">
                                <div class="col-md-8">
                                    <div class="sync-options">
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="autoSyncToggle">
                                            <label class="form-check-label text-light" for="autoSyncToggle">
                                                <strong>Enable automatic sync</strong>
                                                <small class="d-block text-muted">Keep contacts updated across all sources</small>
                                            </label>
                                        </div>

                                        <div id="syncOptions" class="d-none">
                                            <div class="sync-source-list">
                                                <!-- Sync source options -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 7. Network Warm-Up -->
                        <div id="warmupSection" class="section-panel d-none">
                            <div class="text-center mb-4">
                                <h3 class="text-gradient">Network Warm-Up</h3>
                                <p class="text-light">Send a friendly message to reconnect with your network</p>
                            </div>

                            <div class="row">
                                <div class="col-lg-8 mx-auto">
                                    <div class="warmup-tool glass-card p-4">
                                        <h5 class="mb-3">Message Template</h5>
                                        <div class="mb-3">
                                            <textarea class="form-control bg-dark text-light border-secondary" 
                                                      id="warmupMessage" rows="4"
                                                      placeholder="Hey [Name], I'm building something new‚Äîcan I ask you a quick question?">Hey [Name], I'm building something new‚Äîcan I ask you a quick question?</textarea>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label text-light">Select contacts to message:</label>
                                            <div id="warmupContactSelection">
                                                <!-- Contact selection for warm-up -->
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label text-light">Delivery method:</label>
                                            <div class="btn-group w-100">
                                                <input type="radio" class="btn-check" name="deliveryMethod" id="emailDelivery" value="email">
                                                <label class="btn btn-outline-primary" for="emailDelivery">
                                                    <i class="bi bi-envelope me-2"></i>Email
                                                </label>

                                                <input type="radio" class="btn-check" name="deliveryMethod" id="smsDelivery" value="sms">
                                                <label class="btn btn-outline-primary" for="smsDelivery">
                                                    <i class="bi bi-chat-text me-2"></i>SMS
                                                </label>

                                                <input type="radio" class="btn-check" name="deliveryMethod" id="linkedinDelivery" value="linkedin">
                                                <label class="btn btn-outline-primary" for="linkedinDelivery">
                                                    <i class="bi bi-linkedin me-2"></i>LinkedIn
                                                </label>
                                            </div>
                                        </div>

                                        <button class="btn btn-gradient-primary btn-lg w-100" onclick="sendWarmupMessages()">
                                            <i class="bi bi-send me-2"></i>Send Messages
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Final Step -->
                        <div id="completionSection" class="section-panel d-none">
                            <div class="text-center">
                                <div class="mb-4">
                                    <i class="bi bi-check-circle text-success mb-3" style="font-size: 4rem;"></i>
                                    <h2 class="text-gradient mb-3">Your Network is Now Alive Inside Rhiz</h2>
                                    <p class="lead text-light mb-4">Let's make it meaningful.</p>
                                </div>

                                <div class="completion-stats mb-4">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="stat-card">
                                                <div class="stat-number" id="totalContacts">0</div>
                                                <div class="stat-label">Contacts Added</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="stat-card">
                                                <div class="stat-number" id="classifiedContacts">0</div>
                                                <div class="stat-label">Relationships Classified</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="stat-card">
                                                <div class="stat-number" id="trustScores">0</div>
                                                <div class="stat-label">Trust Scores Set</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <button class="btn btn-gradient-primary btn-lg px-5" onclick="continueToGoals()">
                                    Continue to Goals <i class="bi bi-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Footer -->
                    <div class="d-flex justify-content-between align-items-center mt-5">
                        <button class="btn btn-outline-secondary" onclick="goBack()">
                            <i class="bi bi-arrow-left me-2"></i>Back
                        </button>
                        
                        <div class="section-navigation">
                            <button id="skipBtn" class="btn btn-outline-light me-3" onclick="skipSection()">
                                Skip This Step
                            </button>
                            <button id="nextBtn" class="btn btn-primary" onclick="nextSection()" disabled>
                                Next <i class="bi bi-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Import Grid Styles */
.import-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.import-option {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 2rem 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.import-option:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: var(--bs-primary);
    transform: translateY(-4px);
}

.import-option.selected {
    background: rgba(var(--bs-primary-rgb), 0.2);
    border-color: var(--bs-primary);
}

.import-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
}

.import-option h5 {
    color: #fff;
    margin-bottom: 0.5rem;
}

.import-option p {
    margin-bottom: 0;
    font-size: 0.9rem;
}

/* Contact Grid Styles */
.contact-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
    max-height: 500px;
    overflow-y: auto;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 12px;
}

.contact-card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 1rem;
    transition: all 0.3s ease;
}

.contact-card:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-2px);
}

.contact-card.selected {
    border-color: var(--bs-primary);
    background: rgba(var(--bs-primary-rgb), 0.1);
}

/* Section Panel Styles */
.section-panel {
    display: none;
    animation: fadeInUp 0.5s ease;
}

.section-panel.active {
    display: block;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Stat Cards */
.stat-card {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    backdrop-filter: blur(10px);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--bs-primary);
}

.stat-label {
    color: #fff;
    font-size: 0.9rem;
    margin-top: 0.5rem;
}

/* Trust Slider Styles */
.trust-slider {
    width: 100%;
    margin: 1rem 0;
}

.trust-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: #aaa;
    margin-top: 0.5rem;
}

/* Batch Actions */
.batch-actions {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 1rem;
    backdrop-filter: blur(10px);
}

/* Background Orbs */
.background-orb {
    position: absolute;
    width: 500px;
    height: 500px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(0, 123, 255, 0.1) 0%, rgba(0, 123, 255, 0.05) 40%, transparent 70%);
    filter: blur(40px);
    animation: float 20s ease-in-out infinite;
    pointer-events: none;
    z-index: 0;
}

@keyframes float {
    0%, 100% { transform: translate(0, 0) rotate(0deg); }
    33% { transform: translate(30px, -30px) rotate(120deg); }
    66% { transform: translate(-20px, 20px) rotate(240deg); }
}

/* Progress Container */
.progress-container {
    max-width: 400px;
    margin: 0 auto;
}

/* Glass effects for cards */
.glass-card {
    position: relative;
    z-index: 1;
}

/* Enrichment Sidebar */
.enrichment-sidebar {
    position: sticky;
    top: 2rem;
}

/* Warmup tool */
.warmup-tool {
    max-width: 600px;
    margin: 0 auto;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .import-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }
    
    .contact-grid {
        grid-template-columns: 1fr;
    }
    
    .import-option {
        padding: 1.5rem 1rem;
    }
    
    .batch-actions .btn-group {
        flex-direction: column;
        width: 100%;
    }
    
    .batch-actions .btn-group .btn {
        margin-bottom: 0.5rem;
    }
}
</style>

<script>
// Global state
let currentSection = 'import';
let importedContacts = [];
let classifiedContacts = [];
let trustScores = {};
let selectedContacts = new Set();

// Section management
const sections = ['import', 'classification', 'unknown', 'enrichment', 'trust', 'syncSetup', 'warmup', 'completion'];
let currentSectionIndex = 0;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializePage();
    setupEventListeners();
});

function initializePage() {
    // Check if we have existing contacts
    loadExistingContacts();
    
    // Setup section navigation
    updateSectionDisplay();
    updateNavigationButtons();
}

function setupEventListeners() {
    // Import option clicks
    document.querySelectorAll('.import-option').forEach(option => {
        option.addEventListener('click', function() {
            const source = this.dataset.source;
            selectImportSource(source);
        });
    });

    // Select all checkbox
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            toggleSelectAll(this.checked);
        });
    }

    // Auto-sync toggle
    const autoSyncToggle = document.getElementById('autoSyncToggle');
    if (autoSyncToggle) {
        autoSyncToggle.addEventListener('change', function() {
            toggleAutoSync(this.checked);
        });
    }
}

// Import Source Selection
function selectImportSource(source) {
    // Clear previous selections
    document.querySelectorAll('.import-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    
    // Select current option
    document.querySelector(`[data-source="${source}"]`).classList.add('selected');
    
    // Handle different import sources
    switch(source) {
        case 'google':
            initiateGoogleImport();
            break;
        case 'linkedin':
            initiateLinkedInImport();
            break;
        case 'apple':
            initiateAppleImport();
            break;
        case 'twitter':
            showTwitterNotAvailable();
            break;
        case 'manual':
            showManualAddForm();
            break;
        case 'skip':
            skipImport();
            break;
    }
}

// Import Methods (Stubbed with realistic interfaces)
async function initiateGoogleImport() {
    showImportProgress();
    updateImportProgress(10, 'Connecting to Google...', 'Opening secure OAuth window');
    
    try {
        // Simulate OAuth flow
        await simulateOAuth('Google');
        
        updateImportProgress(50, 'Fetching contacts...', 'Downloading your Google contacts');
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        updateImportProgress(80, 'Processing contacts...', 'Organizing and categorizing');
        const contacts = await fetchGoogleContacts(); // Stub
        
        updateImportProgress(100, 'Import complete!', `Successfully imported ${contacts.length} contacts`);
        
        importedContacts = contacts;
        setTimeout(() => {
            hideImportProgress();
            nextSection();
        }, 1500);
        
    } catch (error) {
        hideImportProgress();
        showError('Google import failed. Please try again or use CSV upload.');
    }
}

async function initiateLinkedInImport() {
    showImportProgress();
    updateImportProgress(10, 'Preparing LinkedIn import...', 'Setting up connection scraper');
    
    // Show LinkedIn options modal
    showLinkedInOptionsModal();
}

async function initiateAppleImport() {
    showFileUploadModal('apple', 'Apple/iCloud Contacts', '.vcf,.csv', 
        'Export your contacts from Contacts app or iCloud and upload the file here.');
}

function showTwitterNotAvailable() {
    alert('Twitter/X import is coming soon! For now, you can add contacts manually or use other import methods.');
}

function showManualAddForm() {
    // Show manual contact entry modal
    showManualContactModal();
}

function skipImport() {
    if (confirm('Are you sure you want to skip importing contacts? You can always add them later.')) {
        nextSection();
    }
}

// Import Progress Management
function showImportProgress() {
    document.getElementById('importProgress').classList.remove('d-none');
    document.querySelectorAll('.import-option').forEach(opt => {
        opt.style.pointerEvents = 'none';
        opt.style.opacity = '0.5';
    });
}

function hideImportProgress() {
    document.getElementById('importProgress').classList.add('d-none');
    document.querySelectorAll('.import-option').forEach(opt => {
        opt.style.pointerEvents = 'auto';
        opt.style.opacity = '1';
    });
}

function updateImportProgress(percentage, text, details) {
    const progressBar = document.querySelector('#importProgress .progress-bar');
    const progressText = document.getElementById('importProgressText');
    const progressDetails = document.getElementById('importProgressDetails');
    
    if (progressBar) progressBar.style.width = percentage + '%';
    if (progressText) progressText.textContent = text;
    if (progressDetails) progressDetails.textContent = details;
}

// Contact Classification
function loadContactClassification() {
    const contactGrid = document.getElementById('contactGrid');
    const contactCount = document.getElementById('contactCount');
    
    contactCount.textContent = importedContacts.length;
    
    contactGrid.innerHTML = '';
    
    importedContacts.forEach((contact, index) => {
        const contactCard = createContactCard(contact, index);
        contactGrid.appendChild(contactCard);
    });
}

function createContactCard(contact, index) {
    const card = document.createElement('div');
    card.className = 'contact-card';
    card.dataset.contactId = index;
    
    card.innerHTML = `
        <div class="d-flex align-items-center mb-3">
            <input type="checkbox" class="form-check-input me-3" id="contact_${index}">
            <div class="contact-avatar me-3">
                <img src="${contact.avatar || '/static/default-avatar.png'}" 
                     alt="${contact.name}" class="rounded-circle" width="40" height="40">
            </div>
            <div class="flex-grow-1">
                <h6 class="mb-1 text-light">${contact.name || 'Unknown'}</h6>
                <small class="text-muted">${contact.title || ''}</small>
                ${contact.company ? `<small class="d-block text-muted">${contact.company}</small>` : ''}
            </div>
        </div>
        
        <div class="relationship-controls">
            <select class="form-select form-select-sm bg-dark text-light border-secondary mb-2" 
                    onchange="updateContactType(${index}, this.value)">
                <option value="">Select relationship type</option>
                <option value="friend">üë• Friend</option>
                <option value="family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family</option>
                <option value="colleague">üíº Colleague</option>
                <option value="professional">ü§ù Professional</option>
                <option value="investor">üí∞ Investor</option>
                <option value="mentor">üéì Mentor</option>
                <option value="client">üéØ Client</option>
                <option value="vendor">üõçÔ∏è Vendor</option>
                <option value="other">‚ùì Other</option>
            </select>
            
            <div class="sentiment-selector">
                <small class="text-muted d-block mb-1">Relationship sentiment:</small>
                <div class="btn-group btn-group-sm w-100">
                    <button type="button" class="btn btn-outline-success" onclick="setSentiment(${index}, 'positive')">üòä</button>
                    <button type="button" class="btn btn-outline-warning" onclick="setSentiment(${index}, 'neutral')">üòê</button>
                    <button type="button" class="btn btn-outline-danger" onclick="setSentiment(${index}, 'negative')">üòï</button>
                </div>
            </div>
        </div>
    `;
    
    return card;
}

function updateContactType(contactIndex, type) {
    if (!classifiedContacts[contactIndex]) {
        classifiedContacts[contactIndex] = {};
    }
    classifiedContacts[contactIndex].type = type;
    
    // Update UI to show classification is complete
    const card = document.querySelector(`[data-contact-id="${contactIndex}"]`);
    card.classList.add('classified');
    
    checkClassificationProgress();
}

function setSentiment(contactIndex, sentiment) {
    if (!classifiedContacts[contactIndex]) {
        classifiedContacts[contactIndex] = {};
    }
    classifiedContacts[contactIndex].sentiment = sentiment;
    
    // Update button states
    const card = document.querySelector(`[data-contact-id="${contactIndex}"]`);
    const buttons = card.querySelectorAll('.sentiment-selector .btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    
    const sentimentMap = { positive: 0, neutral: 1, negative: 2 };
    buttons[sentimentMap[sentiment]].classList.add('active');
    
    checkClassificationProgress();
}

function batchTag(type) {
    const checkedBoxes = document.querySelectorAll('#contactGrid input[type="checkbox"]:checked');
    checkedBoxes.forEach(checkbox => {
        const contactId = parseInt(checkbox.id.split('_')[1]);
        const select = checkbox.closest('.contact-card').querySelector('select');
        select.value = type;
        updateContactType(contactId, type);
    });
}

function toggleSelectAll(checked) {
    const checkboxes = document.querySelectorAll('#contactGrid input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = checked;
    });
}

function checkClassificationProgress() {
    const classifiedCount = Object.keys(classifiedContacts).length;
    const totalContacts = importedContacts.length;
    
    // Enable next button if at least 50% are classified
    const nextBtn = document.getElementById('nextBtn');
    if (classifiedCount >= Math.ceil(totalContacts * 0.5)) {
        nextBtn.disabled = false;
    }
}

// Trust Calibration
function loadTrustCalibration() {
    const trustContactList = document.getElementById('trustContactList');
    
    // Show only classified contacts with important relationship types
    const importantContacts = importedContacts.filter((contact, index) => {
        const classification = classifiedContacts[index];
        return classification && ['professional', 'investor', 'mentor', 'client'].includes(classification.type);
    });
    
    trustContactList.innerHTML = '';
    
    importantContacts.forEach((contact, originalIndex) => {
        const trustCard = createTrustCard(contact, originalIndex);
        trustContactList.appendChild(trustCard);
    });
}

function createTrustCard(contact, index) {
    const card = document.createElement('div');
    card.className = 'trust-card mb-4 p-4';
    card.style.background = 'rgba(255, 255, 255, 0.05)';
    card.style.borderRadius = '12px';
    
    card.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="d-flex align-items-center">
                    <img src="${contact.avatar || '/static/default-avatar.png'}" 
                         alt="${contact.name}" class="rounded-circle me-3" width="50" height="50">
                    <div>
                        <h6 class="mb-1 text-light">${contact.name}</h6>
                        <small class="text-muted">${contact.title || ''}</small>
                        ${contact.company ? `<small class="d-block text-muted">${contact.company}</small>` : ''}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <label class="form-label text-light">Trust Level</label>
                <input type="range" class="form-range trust-slider" 
                       min="1" max="5" value="3" 
                       oninput="updateTrustScore(${index}, this.value)"
                       id="trust_${index}">
                <div class="trust-labels">
                    <span>üòü Low</span>
                    <span>üòê Medium</span>
                    <span>üòä High</span>
                </div>
                <div class="text-center mt-2">
                    <span class="badge bg-primary" id="trustValue_${index}">3</span>
                </div>
            </div>
        </div>
    `;
    
    return card;
}

function updateTrustScore(contactIndex, score) {
    trustScores[contactIndex] = parseInt(score);
    document.getElementById(`trustValue_${contactIndex}`).textContent = score;
    
    // Update badge color based on score
    const badge = document.getElementById(`trustValue_${contactIndex}`);
    badge.className = 'badge ' + (score <= 2 ? 'bg-danger' : score <= 3 ? 'bg-warning' : 'bg-success');
}

// Auto-Sync Setup
function toggleAutoSync(enabled) {
    const syncOptions = document.getElementById('syncOptions');
    if (enabled) {
        syncOptions.classList.remove('d-none');
        loadSyncOptions();
    } else {
        syncOptions.classList.add('d-none');
    }
}

function loadSyncOptions() {
    const syncSourceList = document.querySelector('.sync-source-list');
    
    const sources = [
        { id: 'google', name: 'Google Contacts', icon: 'bi-google', connected: false },
        { id: 'apple', name: 'Apple/iCloud', icon: 'bi-apple', connected: false },
        { id: 'linkedin', name: 'LinkedIn', icon: 'bi-linkedin', connected: false }
    ];
    
    syncSourceList.innerHTML = sources.map(source => `
        <div class="sync-source-item d-flex align-items-center justify-content-between p-3 mb-2 border border-secondary rounded">
            <div class="d-flex align-items-center">
                <i class="${source.icon} me-3" style="font-size: 1.5rem;"></i>
                <div>
                    <h6 class="mb-0 text-light">${source.name}</h6>
                    <small class="text-muted">${source.connected ? 'Connected' : 'Not connected'}</small>
                </div>
            </div>
            <div>
                <button class="btn btn-outline-primary btn-sm" onclick="toggleSyncSource('${source.id}')">
                    ${source.connected ? 'Disconnect' : 'Connect'}
                </button>
            </div>
        </div>
    `).join('');
}

function toggleSyncSource(sourceId) {
    // Stub for sync source toggle
    alert(`${sourceId} sync toggle - would integrate with OAuth here`);
}

// Network Warm-up
function loadWarmupContactSelection() {
    const warmupContactSelection = document.getElementById('warmupContactSelection');
    
    // Show classified contacts
    const selectableContacts = importedContacts.filter((contact, index) => {
        return classifiedContacts[index] && classifiedContacts[index].type;
    });
    
    warmupContactSelection.innerHTML = `
        <div class="warmup-contact-grid" style="max-height: 200px; overflow-y: auto;">
            ${selectableContacts.map((contact, index) => `
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" value="${index}" id="warmup_${index}">
                    <label class="form-check-label text-light" for="warmup_${index}">
                        <strong>${contact.name}</strong>
                        ${contact.title ? ` - ${contact.title}` : ''}
                    </label>
                </div>
            `).join('')}
        </div>
    `;
}

function sendWarmupMessages() {
    const selectedMethod = document.querySelector('input[name="deliveryMethod"]:checked');
    const selectedContactCheckboxes = document.querySelectorAll('#warmupContactSelection input:checked');
    const message = document.getElementById('warmupMessage').value;
    
    if (!selectedMethod) {
        alert('Please select a delivery method');
        return;
    }
    
    if (selectedContactCheckboxes.length === 0) {
        alert('Please select at least one contact');
        return;
    }
    
    if (!message.trim()) {
        alert('Please enter a message');
        return;
    }
    
    // Stub for sending messages
    alert(`Would send message via ${selectedMethod.value} to ${selectedContactCheckboxes.length} contacts:\n\n"${message}"`);
    
    // Move to completion
    nextSection();
}

// Section Navigation
function nextSection() {
    if (currentSectionIndex < sections.length - 1) {
        currentSectionIndex++;
        currentSection = sections[currentSectionIndex];
        updateSectionDisplay();
        updateNavigationButtons();
        
        // Load section-specific content
        loadSectionContent();
    }
}

function goBack() {
    if (currentSectionIndex === 0) {
        window.location.href = '/onboarding/sync';
    } else {
        currentSectionIndex--;
        currentSection = sections[currentSectionIndex];
        updateSectionDisplay();
        updateNavigationButtons();
    }
}

function skipSection() {
    nextSection();
}

function updateSectionDisplay() {
    // Hide all sections
    document.querySelectorAll('.section-panel').forEach(panel => {
        panel.classList.remove('active');
        panel.classList.add('d-none');
    });
    
    // Show current section
    const currentPanel = document.getElementById(currentSection + 'Section');
    if (currentPanel) {
        currentPanel.classList.remove('d-none');
        currentPanel.classList.add('active');
    }
    
    // Update progress bar
    const progressPercentage = ((currentSectionIndex + 1) / sections.length) * 100;
    const progressBar = document.querySelector('.progress-bar');
    if (progressBar) {
        progressBar.style.width = progressPercentage + '%';
    }
}

function updateNavigationButtons() {
    const nextBtn = document.getElementById('nextBtn');
    const skipBtn = document.getElementById('skipBtn');
    
    // Update next button text and state
    if (currentSectionIndex === sections.length - 1) {
        nextBtn.textContent = 'Complete';
        nextBtn.onclick = continueToGoals;
    } else {
        nextBtn.innerHTML = 'Next <i class="bi bi-arrow-right ms-2"></i>';
        nextBtn.onclick = nextSection;
    }
    
    // Hide skip button on completion section
    if (currentSection === 'completion') {
        skipBtn.style.display = 'none';
    } else {
        skipBtn.style.display = 'inline-block';
    }
}

function loadSectionContent() {
    switch(currentSection) {
        case 'classification':
            loadContactClassification();
            break;
        case 'trust':
            loadTrustCalibration();
            break;
        case 'syncSetup':
            // Auto-sync content is already loaded
            break;
        case 'warmup':
            loadWarmupContactSelection();
            break;
        case 'completion':
            loadCompletionStats();
            break;
    }
}

function loadCompletionStats() {
    document.getElementById('totalContacts').textContent = importedContacts.length;
    document.getElementById('classifiedContacts').textContent = Object.keys(classifiedContacts).length;
    document.getElementById('trustScores').textContent = Object.keys(trustScores).length;
}

// Final Actions
function continueToGoals() {
    // Save all network data
    saveNetworkData();
    
    // Redirect to goals onboarding
    window.location.href = '/onboarding/goals';
}

function continueToEnrichment() {
    nextSection();
}

// Data Management
async function loadExistingContacts() {
    try {
        const response = await fetch('/api/contacts');
        if (response.ok) {
            const data = await response.json();
            if (data.contacts && data.contacts.length > 0) {
                importedContacts = data.contacts;
                // Skip import section if we have contacts
                currentSectionIndex = 1;
                currentSection = 'classification';
                updateSectionDisplay();
                updateNavigationButtons();
                loadSectionContent();
            }
        }
    } catch (error) {
        console.log('No existing contacts found, starting fresh');
    }
}

async function saveNetworkData() {
    const networkData = {
        contacts: importedContacts,
        classifications: classifiedContacts,
        trustScores: trustScores,
        completedSections: sections.slice(0, currentSectionIndex + 1)
    };
    
    try {
        const response = await fetch('/api/onboarding/network', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(networkData)
        });
        
        if (response.ok) {
            console.log('Network data saved successfully');
        }
    } catch (error) {
        console.error('Failed to save network data:', error);
    }
}

// Mock Data Functions (for development)
async function simulateOAuth(provider) {
    return new Promise(resolve => {
        setTimeout(() => {
            console.log(`${provider} OAuth completed`);
            resolve();
        }, 1500);
    });
}

async function fetchGoogleContacts() {
    // Mock Google contacts
    return [
        { name: 'Alice Johnson', title: 'Product Manager', company: 'TechCorp', email: 'alice@techcorp.com' },
        { name: 'Bob Smith', title: 'Investor', company: 'Venture Capital', email: 'bob@vc.com' },
        { name: 'Carol Davis', title: 'Designer', company: 'Design Studio', email: 'carol@design.com' },
        { name: 'David Wilson', title: 'Engineer', company: 'StartupXYZ', email: 'david@startup.com' },
        { name: 'Emma Brown', title: 'Marketing Director', company: 'Marketing Inc', email: 'emma@marketing.com' }
    ];
}

// Modal Functions (Stubs)
function showLinkedInOptionsModal() {
    alert('LinkedIn Import Modal - would show scraper vs CSV upload options');
    // For now, simulate import
    importedContacts = [
        { name: 'LinkedIn Contact 1', title: 'CEO', company: 'LinkedIn Corp' },
        { name: 'LinkedIn Contact 2', title: 'CTO', company: 'Tech Startup' }
    ];
    hideImportProgress();
    nextSection();
}

function showFileUploadModal(source, title, accept, instructions) {
    alert(`${title} File Upload Modal\nAccept: ${accept}\nInstructions: ${instructions}`);
    // Simulate file upload
    importedContacts = [
        { name: 'File Contact 1', title: 'Manager', company: 'File Corp' },
        { name: 'File Contact 2', title: 'Director', company: 'Import Inc' }
    ];
    nextSection();
}

function showManualContactModal() {
    alert('Manual Contact Entry Modal - would show form to add individual contacts');
    // Simulate manual entry
    importedContacts = [
        { name: 'Manual Contact', title: 'Friend', company: 'Personal' }
    ];
    nextSection();
}

function showError(message) {
    alert('Error: ' + message);
}
</script>
{% endblock %}