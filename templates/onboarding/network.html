<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Network Map - Rhiz</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .btn-continue {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none;
            border-radius: 15px;
            padding: 12px 32px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-continue:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            height: 100%;
            transition: width 0.5s ease;
        }
        
        #networkViz {
            width: 100%;
            height: 400px;
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .trust-ring {
            stroke-width: 3;
            fill: none;
        }
        
        .trust-high { stroke: #10b981; }
        .trust-medium { stroke: #f59e0b; }
        .trust-low { stroke: #ef4444; }
        .trust-new { stroke: #6b7280; }
        
        .node-text {
            font-size: 10px;
            text-anchor: middle;
            fill: white;
            pointer-events: none;
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .filter-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 8px 16px;
            margin: 0 5px;
            color: white;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }
        
        .filter-btn:hover, .filter-btn.active {
            background: rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
            color: white;
        }
        
        .contact-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            transition: right 0.3s ease;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .contact-panel.open {
            right: 0;
        }
        
        .trust-score {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 auto 15px;
        }
        
        .trust-high-bg { background: linear-gradient(135deg, #10b981, #059669); }
        .trust-medium-bg { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .trust-low-bg { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .trust-new-bg { background: linear-gradient(135deg, #6b7280, #4b5563); }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <!-- Progress Bar -->
                <div class="progress-bar mb-4 mt-3">
                    <div class="progress-fill" style="width: 75%"></div>
                </div>
                
                <!-- Header -->
                <div class="glass-card p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="gradient-text mb-2">Your Network Map</h1>
                            <p class="text-light mb-0">Explore your relationships and trust connections</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-light" onclick="addManualContact()">
                                <i class="bi bi-person-plus me-2"></i>Add Contact
                            </button>
                            <button class="btn btn-continue" onclick="completeOnboarding()">
                                Continue <i class="bi bi-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Controls -->
                <div class="controls">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button class="filter-btn active" data-filter="all">All</button>
                            <button class="filter-btn" data-filter="high">High Trust</button>
                            <button class="filter-btn" data-filter="medium">Medium Trust</button>
                            <button class="filter-btn" data-filter="low">Low Trust</button>
                            <button class="filter-btn" data-filter="new">New</button>
                        </div>
                        <div class="text-light">
                            <small><span id="contactCount">0</span> contacts in your network</small>
                        </div>
                    </div>
                </div>
                
                <!-- Network Visualization -->
                <div class="glass-card p-4">
                    <div id="networkViz"></div>
                </div>
                
                <!-- Empty State -->
                <div id="emptyState" class="glass-card p-5 text-center d-none">
                    <i class="bi bi-people text-primary" style="font-size: 4rem;"></i>
                    <h3 class="gradient-text mt-3">Start Building Your Network</h3>
                    <p class="text-light mb-4">Add your first contacts to see the relationship intelligence in action</p>
                    <button class="btn btn-continue" onclick="addManualContact()">
                        <i class="bi bi-person-plus me-2"></i>Add Your First Contact
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Contact Trust Panel -->
    <div id="contactPanel" class="contact-panel">
        <div class="p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="text-light mb-0">Contact Details</h5>
                <button class="btn-close btn-close-white" onclick="closeContactPanel()"></button>
            </div>
            
            <div id="contactDetails">
                <!-- Will be populated when contact is selected -->
            </div>
        </div>
    </div>

    <script>
        let networkData = [];
        let filteredData = [];
        let svg, simulation;
        
        // Initialize the network visualization
        async function initNetwork() {
            try {
                const response = await fetch('/api/contacts');
                const contacts = await response.json();
                
                if (contacts.length === 0) {
                    showEmptyState();
                    return;
                }
                
                networkData = contacts.map(contact => ({
                    id: contact.id,
                    name: contact.name || contact.email,
                    email: contact.email,
                    trust_level: contact.trust_level || 'new',
                    last_contact: contact.last_contact,
                    relationship_type: contact.relationship_type,
                    notes: contact.notes
                }));
                
                updateContactCount(networkData.length);
                renderNetwork(networkData);
            } catch (error) {
                console.error('Error loading contacts:', error);
                showEmptyState();
            }
        }
        
        function showEmptyState() {
            document.getElementById('networkViz').style.display = 'none';
            document.getElementById('emptyState').classList.remove('d-none');
        }
        
        function hideEmptyState() {
            document.getElementById('networkViz').style.display = 'block';
            document.getElementById('emptyState').classList.add('d-none');
        }
        
        function renderNetwork(data) {
            if (data.length === 0) {
                showEmptyState();
                return;
            }
            
            hideEmptyState();
            
            // Clear previous visualization
            d3.select("#networkViz").selectAll("*").remove();
            
            const width = document.getElementById('networkViz').offsetWidth;
            const height = 400;
            
            svg = d3.select("#networkViz")
                .append("svg")
                .attr("width", width)
                .attr("height", height);
            
            // Create simulation
            simulation = d3.forceSimulation(data)
                .force("charge", d3.forceManyBody().strength(-100))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(25));
            
            // Create trust rings
            const rings = svg.selectAll(".trust-ring")
                .data(data)
                .enter().append("circle")
                .attr("class", d => `trust-ring trust-${d.trust_level}`)
                .attr("r", 20);
            
            // Create node circles
            const nodes = svg.selectAll(".node")
                .data(data)
                .enter().append("circle")
                .attr("class", "node")
                .attr("r", 15)
                .attr("fill", d => getTrustColor(d.trust_level))
                .style("cursor", "pointer")
                .on("click", showContactDetails);
            
            // Create node labels
            const labels = svg.selectAll(".node-text")
                .data(data)
                .enter().append("text")
                .attr("class", "node-text")
                .text(d => getDisplayName(d.name));
            
            // Update positions on simulation tick
            simulation.on("tick", () => {
                rings
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);
                    
                nodes
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);
                    
                labels
                    .attr("x", d => d.x)
                    .attr("y", d => d.y + 35);
            });
        }
        
        function getTrustColor(level) {
            const colors = {
                'high': '#10b981',
                'medium': '#f59e0b', 
                'low': '#ef4444',
                'new': '#6b7280'
            };
            return colors[level] || colors['new'];
        }
        
        function getDisplayName(name) {
            if (!name) return 'Contact';
            return name.length > 10 ? name.substring(0, 8) + '...' : name;
        }
        
        function showContactDetails(event, d) {
            const panel = document.getElementById('contactPanel');
            const details = document.getElementById('contactDetails');
            
            const trustClass = `trust-${d.trust_level}-bg`;
            const trustScore = getTrustScore(d.trust_level);
            
            details.innerHTML = `
                <div class="text-center mb-4">
                    <div class="trust-score ${trustClass}">
                        ${trustScore}
                    </div>
                    <h4 class="text-light">${d.name || 'Contact'}</h4>
                    <small class="text-muted">${d.email || ''}</small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label text-light">Trust Level</label>
                    <div class="text-capitalize text-${getTrustBootstrapClass(d.trust_level)}">${d.trust_level}</div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label text-light">Relationship</label>
                    <div class="text-light">${d.relationship_type || 'Not specified'}</div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label text-light">Last Contact</label>
                    <div class="text-light">${d.last_contact || 'Never'}</div>
                </div>
                
                <div class="mb-4">
                    <label class="form-label text-light">Notes</label>
                    <div class="text-light">${d.notes || 'No notes yet'}</div>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="contactPerson(${d.id})">
                        <i class="bi bi-chat-dots me-2"></i>Contact
                    </button>
                    <button class="btn btn-outline-light" onclick="updateContact(${d.id})">
                        <i class="bi bi-pencil me-2"></i>Update
                    </button>
                </div>
            `;
            
            panel.classList.add('open');
        }
        
        function getTrustScore(level) {
            const scores = {
                'high': '9.2',
                'medium': '6.8',
                'low': '3.4',
                'new': '?'
            };
            return scores[level] || '?';
        }
        
        function getTrustBootstrapClass(level) {
            const classes = {
                'high': 'success',
                'medium': 'warning',
                'low': 'danger',
                'new': 'secondary'
            };
            return classes[level] || 'secondary';
        }
        
        function closeContactPanel() {
            document.getElementById('contactPanel').classList.remove('open');
        }
        
        function updateContactCount(count) {
            document.getElementById('contactCount').textContent = count;
        }
        
        // Filter functionality
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const filter = this.dataset.filter;
                if (filter === 'all') {
                    filteredData = networkData;
                } else {
                    filteredData = networkData.filter(d => d.trust_level === filter);
                }
                
                updateContactCount(filteredData.length);
                renderNetwork(filteredData);
            });
        });
        
        function addManualContact() {
            // Simple prompt for now - could be enhanced with a modal
            const name = prompt('Contact name:');
            const email = prompt('Contact email:');
            
            if (name && email) {
                createContact(name, email);
            }
        }
        
        async function createContact(name, email) {
            try {
                const response = await fetch('/api/contacts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        email: email,
                        source: 'manual_onboarding'
                    })
                });
                
                if (response.ok) {
                    // Refresh the network
                    await initNetwork();
                } else {
                    alert('Failed to add contact. Please try again.');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }
        
        function contactPerson(contactId) {
            // Placeholder for contact functionality
            alert('Contact functionality will be available in the full app!');
        }
        
        function updateContact(contactId) {
            // Placeholder for update functionality
            alert('Update functionality will be available in the full app!');
        }
        
        function completeOnboarding() {
            // Store onboarding completion and redirect to main app
            fetch('/api/onboarding/complete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            }).then(response => {
                if (response.ok) {
                    window.location.href = '/dashboard';
                } else {
                    window.location.href = '/dashboard';
                }
            }).catch(() => {
                window.location.href = '/dashboard';
            });
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initNetwork();
        });
    </script>
</body>
</html>