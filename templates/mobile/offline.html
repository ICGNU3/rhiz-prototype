<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline - Rhiz</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/placeholder" rel="stylesheet">
    <style>
        .offline-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        
        .offline-card {
            background: var(--mobile-glass-bg);
            backdrop-filter: var(--mobile-backdrop-blur);
            border: 1px solid var(--mobile-glass-border);
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            max-width: 400px;
            margin: 2rem;
            box-shadow: var(--mobile-glass-shadow);
        }
        
        .offline-icon {
            width: 80px;
            height: 80px;
            background: var(--bs-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            font-size: 2rem;
            color: white;
        }
        
        .cached-actions {
            margin-top: 2rem;
        }
        
        .cached-actions .btn {
            margin: 0.5rem;
        }
        
        .sync-status {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            font-size: 0.9rem;
        }
        
        .network-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bs-warning);
            color: var(--bs-dark);
            border-radius: 20px;
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="offline-container">
        <div class="offline-card">
            <div class="offline-icon pulse">
                <i class="bi bi-wifi-off"></i>
            </div>
            
            <div class="network-status" id="networkStatus">
                <i class="bi bi-exclamation-circle"></i>
                <span>You're offline</span>
            </div>
            
            <h2 class="mb-3">Staying Connected</h2>
            <p class="text-muted mb-4">
                You're currently offline, but you can still access your cached data and perform basic actions.
                We'll sync everything when you're back online.
            </p>
            
            <div class="cached-actions">
                <button class="btn btn-primary" onclick="goHome()">
                    <i class="bi bi-house me-2"></i>
                    Go to Dashboard
                </button>
                
                <button class="btn btn-outline-light" onclick="viewCachedContacts()">
                    <i class="bi bi-people me-2"></i>
                    View Contacts
                </button>
                
                <button class="btn btn-outline-light" onclick="viewCachedGoals()">
                    <i class="bi bi-target me-2"></i>
                    View Goals
                </button>
            </div>
            
            <div class="sync-status">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <span>Offline Data</span>
                    <span class="badge bg-secondary" id="cachedItemsCount">Loading...</span>
                </div>
                
                <div class="progress mb-2" style="height: 4px;">
                    <div class="progress-bar bg-primary" role="progressbar" style="width: 0%" id="syncProgress"></div>
                </div>
                
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Your data will sync automatically when connected
                </small>
            </div>
            
            <button class="btn btn-outline-primary mt-3" onclick="checkConnection()">
                <i class="bi bi-arrow-clockwise me-2"></i>
                Check Connection
            </button>
        </div>
    </div>

    <script>
        let offlineData = {
            contacts: [],
            goals: [],
            interactions: []
        };

        // Initialize offline page
        document.addEventListener('DOMContentLoaded', function() {
            loadOfflineData();
            setupNetworkMonitoring();
            updateCachedItemsCount();
        });

        function loadOfflineData() {
            // Load data from IndexedDB/localStorage
            try {
                const cachedContacts = localStorage.getItem('rhiz_offline_contacts');
                const cachedGoals = localStorage.getItem('rhiz_offline_goals');
                const cachedInteractions = localStorage.getItem('rhiz_offline_interactions');

                if (cachedContacts) {
                    offlineData.contacts = JSON.parse(cachedContacts);
                }
                if (cachedGoals) {
                    offlineData.goals = JSON.parse(cachedGoals);
                }
                if (cachedInteractions) {
                    offlineData.interactions = JSON.parse(cachedInteractions);
                }
            } catch (error) {
                console.error('Error loading offline data:', error);
            }
        }

        function updateCachedItemsCount() {
            const totalItems = offlineData.contacts.length + offlineData.goals.length + offlineData.interactions.length;
            document.getElementById('cachedItemsCount').textContent = totalItems;
            
            // Update progress bar based on cached data
            const progressBar = document.getElementById('syncProgress');
            if (totalItems > 0) {
                progressBar.style.width = '100%';
                progressBar.classList.remove('progress-bar-animated');
            } else {
                progressBar.style.width = '0%';
            }
        }

        function setupNetworkMonitoring() {
            // Monitor network status
            function updateNetworkStatus() {
                const networkStatus = document.getElementById('networkStatus');
                const isOnline = navigator.onLine;
                
                if (isOnline) {
                    networkStatus.innerHTML = '<i class="bi bi-wifi"></i><span>Connected - Syncing...</span>';
                    networkStatus.className = 'network-status';
                    networkStatus.style.background = 'var(--bs-success)';
                    networkStatus.style.color = 'white';
                    
                    // Try to sync and redirect
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    networkStatus.innerHTML = '<i class="bi bi-wifi-off"></i><span>You\'re offline</span>';
                    networkStatus.className = 'network-status';
                    networkStatus.style.background = 'var(--bs-warning)';
                    networkStatus.style.color = 'var(--bs-dark)';
                }
            }

            // Check initial status
            updateNetworkStatus();

            // Listen for network changes
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
        }

        function goHome() {
            if (navigator.onLine) {
                window.location.href = '/';
            } else {
                // Load cached dashboard
                showOfflineToast('Loading cached dashboard data...');
                setTimeout(() => {
                    window.location.href = '/';
                }, 1000);
            }
        }

        function viewCachedContacts() {
            if (offlineData.contacts.length > 0) {
                localStorage.setItem('rhiz_offline_view', 'contacts');
                showOfflineToast(`Loading ${offlineData.contacts.length} cached contacts...`);
                setTimeout(() => {
                    window.location.href = '/contacts';
                }, 1000);
            } else {
                showOfflineToast('No cached contacts available', 'warning');
            }
        }

        function viewCachedGoals() {
            if (offlineData.goals.length > 0) {
                localStorage.setItem('rhiz_offline_view', 'goals');
                showOfflineToast(`Loading ${offlineData.goals.length} cached goals...`);
                setTimeout(() => {
                    window.location.href = '/goals';
                }, 1000);
            } else {
                showOfflineToast('No cached goals available', 'warning');
            }
        }

        function checkConnection() {
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            
            btn.innerHTML = '<i class="bi bi-arrow-clockwise spin me-2"></i>Checking...';
            btn.disabled = true;
            
            // Force network check
            fetch('/api/mobile/network-status', {
                method: 'GET',
                cache: 'no-store'
            })
            .then(response => {
                if (response.ok) {
                    showOfflineToast('Connection restored!', 'success');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1500);
                } else {
                    throw new Error('Still offline');
                }
            })
            .catch(error => {
                showOfflineToast('Still offline. Please check your connection.', 'warning');
            })
            .finally(() => {
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                }, 2000);
            });
        }

        function showOfflineToast(message, type = 'info') {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = `mobile-toast ${type}`;
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.top = '20px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.zIndex = '9999';
            toast.style.padding = '12px 20px';
            toast.style.borderRadius = '8px';
            toast.style.fontSize = '0.9rem';
            
            if (type === 'success') {
                toast.style.background = 'var(--bs-success)';
                toast.style.color = 'white';
            } else if (type === 'warning') {
                toast.style.background = 'var(--bs-warning)';
                toast.style.color = 'var(--bs-dark)';
            } else {
                toast.style.background = 'var(--bs-info)';
                toast.style.color = 'white';
            }
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Add spinning animation for loading
        const style = document.createElement('style');
        style.textContent = `
            .spin {
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>