{% extends "base.html" %}

{% block title %}Welcome to OuRhizome - Enhanced Onboarding{% endblock %}

{% block content %}
<div class="container-fluid vh-100 d-flex align-items-center justify-content-center">
    <div class="onboarding-container" style="max-width: 900px; width: 100%;">
        
        <!-- Progress Indicator -->
        <div class="progress-steps mb-5">
            <div class="d-flex justify-content-between align-items-center">
                <div class="step active" data-step="1">
                    <div class="step-circle">1</div>
                    <span class="step-label">Welcome</span>
                </div>
                <div class="step-line"></div>
                <div class="step" data-step="2">
                    <div class="step-circle">2</div>
                    <span class="step-label">First Goal</span>
                </div>
                <div class="step-line"></div>
                <div class="step" data-step="3">
                    <div class="step-circle">3</div>
                    <span class="step-label">Contacts</span>
                </div>
                <div class="step-line"></div>
                <div class="step" data-step="4">
                    <div class="step-circle">4</div>
                    <span class="step-label">AI Magic</span>
                </div>
            </div>
        </div>

        <!-- Step 1: Welcome -->
        <div class="onboarding-step active" id="step-1">
            <div class="text-center mb-5">
                <img src="{{ url_for('static', filename='images/OuRhizome_logo.png') }}" alt="OuRhizome" class="mb-4" style="height: 80px;">
                <h1 class="h2 mb-3">Welcome to Root Membership</h1>
                <p class="lead text-muted mb-4">Join an exclusive community of One Hundred Root Members building the future together</p>
                <div class="value-props row g-4 mb-5">
                    <div class="col-md-4">
                        <div class="card glass-card h-100 text-center p-4">
                            <i class="bi bi-bullseye display-6 text-primary mb-3"></i>
                            <h5>Goal-First Approach</h5>
                            <p class="small text-muted">Start with what you want to achieve, then find the right people to help you get there</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card glass-card h-100 text-center p-4">
                            <i class="bi bi-cpu display-6 text-info mb-3"></i>
                            <h5>Ambient Intelligence</h5>
                            <p class="small text-muted">AI works quietly in the background, surfacing insights and connections when you need them</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card glass-card h-100 text-center p-4">
                            <i class="bi bi-people-fill display-6 text-success mb-3"></i>
                            <h5>Collective Actions</h5>
                            <p class="small text-muted">Join cohort-based initiatives with other founders to achieve shared goals</p>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary btn-lg" onclick="nextStep()">
                    Begin Setup <i class="bi bi-arrow-right ms-2"></i>
                </button>
            </div>
        </div>

        <!-- Step 2: First Goal -->
        <div class="onboarding-step" id="step-2">
            <div class="text-center mb-4">
                <h2 class="h3 mb-3">What's your primary goal right now?</h2>
                <p class="text-muted">Everything in OuRhizome starts with a goal. This helps AI find the right people and actions for you.</p>
            </div>
            
            <div class="goal-templates mb-4">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="goal-template card border-2" onclick="selectGoalTemplate(this, 'funding')">
                            <div class="card-body">
                                <i class="bi bi-bank text-primary me-2"></i>
                                <strong>Raise Funding</strong>
                                <p class="small text-muted mb-0 mt-1">Connect with investors and prepare for fundraising</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="goal-template card border-2" onclick="selectGoalTemplate(this, 'hiring')">
                            <div class="card-body">
                                <i class="bi bi-person-plus text-success me-2"></i>
                                <strong>Build Team</strong>
                                <p class="small text-muted mb-0 mt-1">Find co-founders, advisors, and key hires</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="goal-template card border-2" onclick="selectGoalTemplate(this, 'customers')">
                            <div class="card-body">
                                <i class="bi bi-people text-info me-2"></i>
                                <strong>Find Customers</strong>
                                <p class="small text-muted mb-0 mt-1">Connect with early adopters and beta users</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="goal-template card border-2" onclick="selectGoalTemplate(this, 'partnerships')">
                            <div class="card-body">
                                <i class="bi bi-handshake text-warning me-2"></i>
                                <strong>Strategic Partnerships</strong>
                                <p class="small text-muted mb-0 mt-1">Build alliances and integration opportunities</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="custom-goal-form">
                <div class="mb-3">
                    <label class="form-label">Goal Title</label>
                    <input type="text" class="form-control" id="goalTitle" placeholder="e.g., Raise Series A funding">
                </div>
                <div class="mb-4">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="goalDescription" rows="3" placeholder="Describe what you want to achieve and any specific details..."></textarea>
                </div>
                
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary" onclick="prevStep()">
                        <i class="bi bi-arrow-left me-1"></i> Back
                    </button>
                    <button class="btn btn-primary flex-grow-1" onclick="createGoalAndNext()" id="createGoalBtn" disabled>
                        Create Goal & Continue <i class="bi bi-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: Add Contacts -->
        <div class="onboarding-step" id="step-3">
            <div class="text-center mb-4">
                <h2 class="h3 mb-3">Add your first contacts</h2>
                <p class="text-muted">Import existing contacts or add key people manually. AI will analyze these to suggest relevant connections.</p>
            </div>

            <div class="import-options row g-4 mb-4">
                <div class="col-md-6">
                    <div class="card glass-card text-center p-4">
                        <i class="bi bi-upload display-6 text-primary mb-3"></i>
                        <h5>Import from LinkedIn</h5>
                        <p class="small text-muted mb-3">Upload your LinkedIn connections CSV for instant setup</p>
                        <button class="btn btn-primary" onclick="showImportModal()">
                            Import Contacts
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card glass-card text-center p-4">
                        <i class="bi bi-person-plus display-6 text-secondary mb-3"></i>
                        <h5>Add Manually</h5>
                        <p class="small text-muted mb-3">Start with a few key contacts and build from there</p>
                        <button class="btn btn-outline-secondary" onclick="showAddContactForm()">
                            Add Contact
                        </button>
                    </div>
                </div>
            </div>

            <div class="contacts-preview" id="contactsPreview" style="display: none;">
                <h6>Added Contacts</h6>
                <div class="contacts-list">
                    <!-- Dynamic contact list -->
                </div>
            </div>

            <div class="d-flex gap-2 mt-4">
                <button class="btn btn-outline-secondary" onclick="prevStep()">
                    <i class="bi bi-arrow-left me-1"></i> Back
                </button>
                <button class="btn btn-primary flex-grow-1" onclick="nextStep()">
                    Continue to AI Setup <i class="bi bi-arrow-right ms-2"></i>
                </button>
                <button class="btn btn-outline-info" onclick="skipStep()">
                    Skip for Now
                </button>
            </div>
        </div>

        <!-- Step 4: AI Magic -->
        <div class="onboarding-step" id="step-4">
            <div class="text-center mb-4">
                <h2 class="h3 mb-3">Your AI Assistant is Ready</h2>
                <p class="text-muted">Based on your goal and contacts, here's what AI has prepared for you</p>
            </div>

            <div class="ai-preview row g-4 mb-4">
                <div class="col-md-4">
                    <div class="card glass-card p-4">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi bi-lightbulb text-warning me-2"></i>
                            <h6 class="mb-0">Smart Suggestions</h6>
                        </div>
                        <div id="aiSuggestions">
                            <div class="ai-suggestion-preview mb-2 p-2 border rounded">
                                <small class="text-muted">Analyzing your goal...</small>
                                <div class="spinner-border spinner-border-sm ms-2" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card glass-card p-4">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi bi-people text-info me-2"></i>
                            <h6 class="mb-0">Potential Connections</h6>
                        </div>
                        <div id="connectionSuggestions">
                            <div class="connection-preview mb-2 p-2 border rounded">
                                <small class="text-muted">Finding relevant connections...</small>
                                <div class="spinner-border spinner-border-sm ms-2" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card glass-card p-4">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi bi-lightning text-success me-2"></i>
                            <h6 class="mb-0">Daily Actions</h6>
                        </div>
                        <div id="dailyActions">
                            <div class="action-preview mb-2 p-2 border rounded">
                                <small class="text-muted">Generating micro-actions...</small>
                                <div class="spinner-border spinner-border-sm ms-2" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="completion-section text-center">
                <div class="mb-4">
                    <i class="bi bi-check-circle display-4 text-success mb-3"></i>
                    <h4>You're All Set!</h4>
                    <p class="text-muted">Your OuRhizome workspace is configured and AI is working in the background</p>
                </div>

                <div class="d-flex gap-2 justify-content-center">
                    <button class="btn btn-outline-secondary" onclick="prevStep()">
                        <i class="bi bi-arrow-left me-1"></i> Back
                    </button>
                    <button class="btn btn-primary btn-lg" onclick="completeOnboarding()">
                        Enter OuRhizome <i class="bi bi-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.onboarding-container {
    padding: 2rem;
}

.progress-steps .step {
    text-align: center;
    opacity: 0.5;
    transition: opacity 0.3s ease;
}

.progress-steps .step.active {
    opacity: 1;
}

.progress-steps .step.completed {
    opacity: 1;
}

.step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bs-secondary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 0.5rem;
    font-weight: 600;
    transition: background-color 0.3s ease;
}

.step.active .step-circle {
    background: var(--bs-primary);
}

.step.completed .step-circle {
    background: var(--bs-success);
}

.step-line {
    flex: 1;
    height: 2px;
    background: var(--bs-secondary);
    margin: 0 1rem;
    align-self: center;
}

.step-label {
    font-size: 0.875rem;
    font-weight: 500;
}

.onboarding-step {
    display: none;
    animation: fadeIn 0.5s ease-in-out;
}

.onboarding-step.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.goal-template {
    cursor: pointer;
    transition: all 0.3s ease;
    border-color: var(--bs-border-color) !important;
}

.goal-template:hover {
    border-color: var(--bs-primary) !important;
    transform: translateY(-2px);
}

.goal-template.selected {
    border-color: var(--bs-primary) !important;
    background: rgba(var(--bs-primary-rgb), 0.1);
}

.ai-suggestion-preview, .connection-preview, .action-preview {
    min-height: 60px;
    display: flex;
    align-items: center;
}
</style>

<script>
let currentStep = 1;
let selectedGoalTemplate = null;
let createdGoalId = null;

function nextStep() {
    if (currentStep < 4) {
        document.getElementById(`step-${currentStep}`).classList.remove('active');
        document.querySelector(`[data-step="${currentStep}"]`).classList.add('completed');
        currentStep++;
        document.getElementById(`step-${currentStep}`).classList.add('active');
        document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');
        
        if (currentStep === 4) {
            generateAIPreviews();
        }
    }
}

function prevStep() {
    if (currentStep > 1) {
        document.getElementById(`step-${currentStep}`).classList.remove('active');
        document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');
        currentStep--;
        document.getElementById(`step-${currentStep}`).classList.add('active');
        document.querySelector(`[data-step="${currentStep}"]`).classList.remove('completed');
    }
}

function selectGoalTemplate(element, type) {
    // Remove previous selection
    document.querySelectorAll('.goal-template').forEach(t => t.classList.remove('selected'));
    
    // Select current template
    element.classList.add('selected');
    selectedGoalTemplate = type;
    
    // Fill form based on template
    const templates = {
        'funding': {
            title: 'Raise Series A funding',
            description: 'Seeking $2-5M Series A funding to scale operations and expand market reach. Looking to connect with VCs focused on our industry and stage.'
        },
        'hiring': {
            title: 'Build core team',
            description: 'Recruiting key positions including CTO, Head of Sales, and senior engineers. Need introductions to top talent and hiring best practices.'
        },
        'customers': {
            title: 'Acquire first 100 customers',
            description: 'Validate product-market fit by finding early adopters and beta users. Looking for warm introductions to potential customers in target market.'
        },
        'partnerships': {
            title: 'Establish strategic partnerships',
            description: 'Form partnerships with complementary companies for distribution, integration, and co-marketing opportunities.'
        }
    };
    
    const template = templates[type];
    document.getElementById('goalTitle').value = template.title;
    document.getElementById('goalDescription').value = template.description;
    document.getElementById('createGoalBtn').disabled = false;
}

// Enable goal creation when form is filled
document.getElementById('goalTitle').addEventListener('input', checkGoalForm);
document.getElementById('goalDescription').addEventListener('input', checkGoalForm);

function checkGoalForm() {
    const title = document.getElementById('goalTitle').value.trim();
    const description = document.getElementById('goalDescription').value.trim();
    document.getElementById('createGoalBtn').disabled = !(title && description);
}

function createGoalAndNext() {
    const title = document.getElementById('goalTitle').value.trim();
    const description = document.getElementById('goalDescription').value.trim();
    
    if (!title || !description) return;
    
    // Create goal via API
    fetch('/api/goals/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            title: title,
            description: description,
            target_date: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] // 90 days from now
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            createdGoalId = data.goal_id;
            nextStep();
        } else {
            alert('Failed to create goal. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error. Please try again.');
    });
}

function showImportModal() {
    // Redirect to import page
    window.location.href = '/contacts/import?onboarding=true';
}

function showAddContactForm() {
    // Show inline contact form
    const formHtml = `
        <div class="card mb-3" id="addContactForm">
            <div class="card-body">
                <h6>Add Contact</h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" placeholder="Name" id="contactName">
                    </div>
                    <div class="col-md-6">
                        <input type="email" class="form-control" placeholder="Email" id="contactEmail">
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" placeholder="Company" id="contactCompany">
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" placeholder="Title" id="contactTitle">
                    </div>
                    <div class="col-12">
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="addContact()">Add Contact</button>
                            <button class="btn btn-outline-secondary" onclick="closeAddContactForm()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.querySelector('.import-options').insertAdjacentHTML('afterend', formHtml);
}

function addContact() {
    const name = document.getElementById('contactName').value.trim();
    const email = document.getElementById('contactEmail').value.trim();
    const company = document.getElementById('contactCompany').value.trim();
    const title = document.getElementById('contactTitle').value.trim();
    
    if (!name || !email) {
        alert('Name and email are required');
        return;
    }
    
    // Add contact via API
    fetch('/contacts/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: name,
            email: email,
            company: company,
            title: title,
            relationship_type: 'professional'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show contact in preview
            showContactsPreview();
            addContactToPreview(data.contact);
            closeAddContactForm();
        } else {
            alert('Failed to add contact. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error. Please try again.');
    });
}

function closeAddContactForm() {
    document.getElementById('addContactForm')?.remove();
}

function showContactsPreview() {
    document.getElementById('contactsPreview').style.display = 'block';
}

function addContactToPreview(contact) {
    const contactHtml = `
        <div class="contact-item d-flex align-items-center justify-content-between p-2 border rounded mb-2">
            <div>
                <strong>${contact.name}</strong>
                <small class="text-muted d-block">${contact.company} ${contact.title ? '• ' + contact.title : ''}</small>
            </div>
            <span class="badge bg-success">Added</span>
        </div>
    `;
    
    document.querySelector('.contacts-list').insertAdjacentHTML('beforeend', contactHtml);
}

function skipStep() {
    nextStep();
}

function generateAIPreviews() {
    // Simulate AI analysis with realistic delays
    setTimeout(() => {
        document.getElementById('aiSuggestions').innerHTML = `
            <div class="ai-suggestion-preview mb-2 p-2 border rounded">
                <small><strong>Sarah Chen</strong> - Former VP at TechCorp</small>
                <div class="small text-muted">95% match • Funding expertise</div>
            </div>
            <div class="ai-suggestion-preview mb-2 p-2 border rounded">
                <small><strong>Marcus Rodriguez</strong> - Partner at Venture Labs</small>
                <div class="small text-muted">87% match • Series A specialist</div>
            </div>
        `;
    }, 2000);
    
    setTimeout(() => {
        document.getElementById('connectionSuggestions').innerHTML = `
            <div class="connection-preview mb-2 p-2 border rounded">
                <small>3 mutual connections with <strong>Alex Kim</strong></small>
                <div class="small text-success">High intro potential</div>
            </div>
            <div class="connection-preview mb-2 p-2 border rounded">
                <small>Shared background with <strong>Jennifer Walsh</strong></small>
                <div class="small text-info">Alumni network</div>
            </div>
        `;
    }, 3000);
    
    setTimeout(() => {
        document.getElementById('dailyActions').innerHTML = `
            <div class="action-preview mb-2 p-2 border rounded">
                <small><strong>Research 3 VCs</strong> focusing on your industry</small>
                <div class="small text-muted">Est. 20 minutes</div>
            </div>
            <div class="action-preview mb-2 p-2 border rounded">
                <small><strong>Update pitch deck</strong> with latest metrics</small>
                <div class="small text-muted">Est. 30 minutes</div>
            </div>
        `;
    }, 4000);
}

function completeOnboarding() {
    // Mark onboarding as complete and redirect to dashboard
    fetch('/api/user/complete-onboarding', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(() => {
        window.location.href = '/';
    })
    .catch(error => {
        console.error('Error:', error);
        // Redirect anyway
        window.location.href = '/';
    });
}
</script>
{% endblock %}