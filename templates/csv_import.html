{% extends "base.html" %}

{% block title %}CSV Contact Import{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1>
                <i class="bi bi-upload me-2"></i>
                CSV Contact Import
            </h1>
            <p class="text-muted">Bulk upload contacts from CSV files with automatic field detection</p>
        </div>
    </div>

    {% if not show_results %}
    <!-- Import Form -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">
                        <i class="bi bi-file-earmark-spreadsheet me-2"></i>
                        Upload CSV File
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data" action="{{ url_for('import_contacts') }}">
                        <div class="mb-3">
                            <label for="csv_file" class="form-label">Choose CSV File</label>
                            <input type="file" class="form-control form-control-lg" id="csv_file" name="csv_file" 
                                   accept=".csv" required>
                            <div class="form-text">
                                Supported formats: CSV files with headers. Maximum file size: 10MB
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="skip_duplicates" 
                                       name="skip_duplicates" checked>
                                <label class="form-check-label" for="skip_duplicates">
                                    Skip duplicate contacts (based on email address)
                                </label>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-upload me-1"></i>Import Contacts
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Import Guidelines
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            <strong>Required:</strong> Name column
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            <strong>Optional:</strong> Email, Company, Title, Phone
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            Headers auto-detected from common formats
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            Duplicate emails automatically skipped
                        </li>
                    </ul>
                    
                    <a href="{{ url_for('download_sample_csv') }}" class="btn btn-outline-info btn-sm">
                        <i class="bi bi-download me-1"></i>Download Sample CSV
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Sample Format Preview -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-table me-2"></i>
                        Sample CSV Format
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#samplePreview">
                        <i class="bi bi-eye"></i> Toggle Preview
                    </button>
                </div>
                <div class="collapse" id="samplePreview">
                    <div class="card-body">
                        <p class="text-muted mb-3">Your CSV can include any of these columns (case-insensitive headers):</p>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Field</th>
                                        <th>Accepted Column Names</th>
                                        <th>Example</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Name*</strong></td>
                                        <td>name, full_name, contact_name</td>
                                        <td>John Smith</td>
                                    </tr>
                                    <tr>
                                        <td>Email</td>
                                        <td>email, email_address</td>
                                        <td>john@example.com</td>
                                    </tr>
                                    <tr>
                                        <td>Company</td>
                                        <td>company, organization, employer</td>
                                        <td>TechCorp</td>
                                    </tr>
                                    <tr>
                                        <td>Title</td>
                                        <td>title, job_title, position</td>
                                        <td>CEO</td>
                                    </tr>
                                    <tr>
                                        <td>Phone</td>
                                        <td>phone, phone_number, mobile</td>
                                        <td>555-1234</td>
                                    </tr>
                                    <tr>
                                        <td>LinkedIn</td>
                                        <td>linkedin, linkedin_url</td>
                                        <td>linkedin.com/in/johnsmith</td>
                                    </tr>
                                    <tr>
                                        <td>Notes</td>
                                        <td>notes, description, comments</td>
                                        <td>Met at conference</td>
                                    </tr>
                                    <tr>
                                        <td>Relationship</td>
                                        <td>relationship_type, type</td>
                                        <td>Investor, Mentor, Contact</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <p class="text-muted small">* Required field</p>
                        
                        <div class="bg-light p-3 rounded">
                            <h6>Sample CSV Content:</h6>
                            <pre class="mb-0 small">{{ sample_csv }}</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Import Results -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-{{ 'success' if summary.successful > 0 else 'warning' }} d-flex align-items-center">
                <i class="bi bi-{{ 'check-circle-fill' if summary.successful > 0 else 'exclamation-triangle-fill' }} me-2"></i>
                <div>
                    <strong>Import Complete!</strong> 
                    {{ summary.successful }} of {{ summary.total_processed }} contacts imported successfully
                    ({{ "%.1f" | format(summary.success_rate) }}% success rate)
                </div>
                <a href="{{ url_for('import_contacts') }}" class="btn btn-sm btn-outline-{{ 'success' if summary.successful > 0 else 'warning' }} ms-auto">
                    <i class="bi bi-plus me-1"></i>Import More
                </a>
            </div>
        </div>
    </div>

    <!-- Import Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center border-success">
                <div class="card-body">
                    <h2 class="text-success">{{ summary.successful }}</h2>
                    <p class="card-text">Successful</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-danger">
                <div class="card-body">
                    <h2 class="text-danger">{{ summary.failed }}</h2>
                    <p class="card-text">Failed</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <h2 class="text-warning">{{ summary.warnings }}</h2>
                    <p class="card-text">Warnings</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-info">
                <div class="card-body">
                    <h2 class="text-info">{{ summary.total_processed }}</h2>
                    <p class="card-text">Total Processed</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Results -->
    {% if import_stats.errors or import_stats.warnings %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-list-ul me-2"></i>
                        Import Details
                    </h5>
                </div>
                <div class="card-body">
                    {% if import_stats.errors %}
                    <div class="mb-4">
                        <h6 class="text-danger">
                            <i class="bi bi-exclamation-circle me-1"></i>
                            Errors ({{ import_stats.errors|length }})
                        </h6>
                        <div class="list-group">
                            {% for error in import_stats.errors[:10] %}
                            <div class="list-group-item list-group-item-danger">
                                <small>{{ error }}</small>
                            </div>
                            {% endfor %}
                            {% if import_stats.errors|length > 10 %}
                            <div class="list-group-item list-group-item-light">
                                <small class="text-muted">... and {{ import_stats.errors|length - 10 }} more errors</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if import_stats.warnings %}
                    <div class="mb-4">
                        <h6 class="text-warning">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            Warnings ({{ import_stats.warnings|length }})
                        </h6>
                        <div class="list-group">
                            {% for warning in import_stats.warnings[:10] %}
                            <div class="list-group-item list-group-item-warning">
                                <small>{{ warning }}</small>
                            </div>
                            {% endfor %}
                            {% if import_stats.warnings|length > 10 %}
                            <div class="list-group-item list-group-item-light">
                                <small class="text-muted">... and {{ import_stats.warnings|length - 10 }} more warnings</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <a href="{{ url_for('contacts') }}" class="btn btn-primary me-2">
                <i class="bi bi-people me-1"></i>View All Contacts
            </a>
            <a href="{{ url_for('core_routes.dashboard') }}" class="btn btn-secondary">
                <i class="bi bi-house me-1"></i>Back to Dashboard
            </a>
        </div>
    </div>
    {% endif %}
</div>

<script>
// File upload validation
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('csv_file');
    
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                // Check file size (10MB limit)
                if (file.size > 10 * 1024 * 1024) {
                    alert('File size must be less than 10MB');
                    this.value = '';
                    return;
                }
                
                // Check file extension
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    alert('Please select a CSV file');
                    this.value = '';
                    return;
                }
            }
        });
    }
});
</script>
{% endblock %}