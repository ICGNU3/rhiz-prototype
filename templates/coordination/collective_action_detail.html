{% extends "base.html" %}

{% block title %}{{ action.title }} - Collective Actions{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Action Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/collective_actions">Collective Actions</a></li>
                            <li class="breadcrumb-item active">{{ action.title }}</li>
                        </ol>
                    </nav>
                    <h1 class="h2 mb-2">{{ action.title }}</h1>
                    <p class="text-muted mb-3">{{ action.description }}</p>
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <span class="badge bg-primary">{{ action.category|title }}</span>
                        <span class="badge bg-success">{{ action.goal_amount }}</span>
                        <span class="badge bg-info">{{ action.timeline_days }} days</span>
                    </div>
                </div>
                {% if user_participating %}
                <div class="text-end">
                    <button class="btn btn-outline-primary btn-sm" onclick="showProgressModal()">
                        <i class="bi bi-plus-circle me-1"></i>Update Progress
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            {% if user_participating %}
            <!-- Your Progress Card -->
            <div class="card mb-4 border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-person-check me-2"></i>Your Progress</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Individual Goal</label>
                                <p class="mb-0">{{ user_participation.individual_goal }}</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Progress</label>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: {{ user_participation.progress_data.progress_percentage|default(0) }}%">
                                    </div>
                                </div>
                                <small class="text-muted">{{ user_participation.progress_data.progress_percentage|default(0)|round }}% complete</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Milestones Completed</label>
                                <p class="mb-0">{{ user_participation.progress_data.milestones_completed|length|default(0) }} / {{ action.resources.milestones|length }}</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Last Check-in</label>
                                <p class="mb-0">
                                    {% if user_participation.last_check_in %}
                                        {{ user_participation.last_check_in|timeago }}
                                    {% else %}
                                        Never
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>

                    {% if user_participation.progress_data.milestones_completed %}
                    <div class="mt-3">
                        <label class="form-label fw-bold">Completed Milestones</label>
                        <div class="d-flex flex-wrap gap-2">
                            {% for milestone in user_participation.progress_data.milestones_completed %}
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle me-1"></i>{{ milestone.milestone }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Group Progress -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-people me-2"></i>Group Progress</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="mb-2">
                                <h4 class="text-primary mb-0">{{ group_progress.total_participants }}</h4>
                                <small class="text-muted">Participants</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-2">
                                <h4 class="text-success mb-0">{{ group_progress.avg_progress }}%</h4>
                                <small class="text-muted">Avg Progress</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-2">
                                <h4 class="text-info mb-0">{{ group_progress.milestones_completed }}</h4>
                                <small class="text-muted">Total Milestones</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-2">
                                <h4 class="text-warning mb-0">{{ group_progress.days_remaining }}</h4>
                                <small class="text-muted">Days Left</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="progress" style="height: 12px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {{ group_progress.avg_progress }}%">
                                {{ group_progress.avg_progress }}%
                            </div>
                        </div>
                        <small class="text-muted">Collective progress toward {{ action.goal_amount }}</small>
                    </div>
                </div>
            </div>

            <!-- Activity Feed -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-activity me-2"></i>Activity Feed</h5>
                    {% if user_participating %}
                    <button class="btn btn-outline-primary btn-sm" onclick="showMessageModal()">
                        <i class="bi bi-chat-dots me-1"></i>Post Update
                    </button>
                    {% endif %}
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    {% if feed_items %}
                        {% for item in feed_items %}
                        <div class="d-flex mb-3 pb-3 border-bottom">
                            <div class="flex-shrink-0 me-3">
                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px;">
                                    {% if item.type == 'update' %}
                                        <i class="bi bi-graph-up text-white"></i>
                                    {% else %}
                                        <i class="bi bi-chat-dots text-white"></i>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <h6 class="mb-0">{{ item.user_email or 'System' }}</h6>
                                    <small class="text-muted">{{ item.created_at|timeago }}</small>
                                </div>
                                
                                {% if item.type == 'update' %}
                                    <p class="mb-1">{{ item.content }}</p>
                                    {% if item.milestone_achieved %}
                                        <span class="badge bg-success mb-1">
                                            <i class="bi bi-trophy me-1"></i>Milestone: {{ item.milestone_achieved }}
                                        </span>
                                    {% endif %}
                                    {% if item.progress_percentage %}
                                        <div class="progress mt-2" style="height: 4px;">
                                            <div class="progress-bar bg-success" style="width: {{ item.progress_percentage }}%"></div>
                                        </div>
                                        <small class="text-muted">{{ item.progress_percentage|round }}% complete</small>
                                    {% endif %}
                                {% else %}
                                    <p class="mb-0">{{ item.content }}</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-chat-text text-muted" style="font-size: 3rem;"></i>
                            <h5 class="text-muted mt-3">No updates yet</h5>
                            <p class="text-muted">Be the first to share your progress!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Resources -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-collection me-2"></i>Resources</h5>
                </div>
                <div class="card-body">
                    <!-- Templates -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-primary">
                            <i class="bi bi-file-earmark-text me-1"></i>Templates
                        </h6>
                        <ul class="list-unstyled">
                            {% for template in action.resources.templates %}
                            <li class="mb-1">
                                <a href="#" class="text-decoration-none">
                                    <i class="bi bi-download me-1"></i>{{ template }}
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>

                    <!-- Advisors -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-success">
                            <i class="bi bi-person-badge me-1"></i>Advisors
                        </h6>
                        {% for advisor in action.resources.advisors %}
                        <div class="d-flex align-items-center mb-2">
                            <div class="bg-success rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                            <small>{{ advisor }}</small>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Intro Opportunities -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-info">
                            <i class="bi bi-share me-1"></i>Intro Opportunities
                        </h6>
                        <ul class="list-unstyled">
                            {% for intro in action.resources.intro_opportunities %}
                            <li class="mb-1">
                                <small><i class="bi bi-arrow-right me-1"></i>{{ intro }}</small>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Milestones -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-flag me-2"></i>Milestones</h5>
                </div>
                <div class="card-body">
                    {% for milestone in action.resources.milestones %}
                    <div class="d-flex align-items-center mb-3">
                        {% if user_participating and milestone in (user_participation.progress_data.milestones_completed | map(attribute='milestone') | list) %}
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                        {% else %}
                            <i class="bi bi-circle text-muted me-2"></i>
                        {% endif %}
                        <small class="{% if user_participating and milestone in (user_participation.progress_data.milestones_completed | map(attribute='milestone') | list) %}text-success fw-bold{% endif %}">
                            {{ milestone }}
                        </small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress Update Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressModalLabel">Update Progress</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="progressForm">
                    <input type="hidden" name="action_id" value="{{ action.id }}">
                    
                    <div class="mb-3">
                        <label for="updateContent" class="form-label">Progress Update</label>
                        <textarea class="form-control" id="updateContent" name="content" rows="4" 
                                  placeholder="Share what you've accomplished, challenges you're facing, or wins you've had..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="progressPercentage" class="form-label">Progress Percentage</label>
                        <input type="range" class="form-range" id="progressPercentage" name="progress_percentage" 
                               min="0" max="100" value="{{ user_participation.progress_data.progress_percentage|default(0) }}"
                               oninput="updateProgressLabel(this.value)">
                        <div class="d-flex justify-content-between text-muted small">
                            <span>0%</span>
                            <span id="progressLabel">{{ user_participation.progress_data.progress_percentage|default(0)|round }}%</span>
                            <span>100%</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="milestoneAchieved" class="form-label">Milestone Achieved (Optional)</label>
                        <select class="form-select" id="milestoneAchieved" name="milestone_achieved">
                            <option value="">Select a milestone...</option>
                            {% for milestone in action.resources.milestones %}
                                {% if not (user_participating and milestone in (user_participation.progress_data.milestones_completed | map(attribute='milestone') | list)) %}
                                <option value="{{ milestone }}">{{ milestone }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitProgress()">
                    <i class="bi bi-check-circle me-1"></i>Update Progress
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Message Modal -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="messageModalLabel">Post Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="messageForm">
                    <input type="hidden" name="action_id" value="{{ action.id }}">
                    
                    <div class="mb-3">
                        <label for="messageType" class="form-label">Message Type</label>
                        <select class="form-select" id="messageType" name="message_type">
                            <option value="update">Progress Update</option>
                            <option value="question">Question</option>
                            <option value="tip">Tip/Advice</option>
                            <option value="celebration">Celebration</option>
                            <option value="support">Support Request</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="messageContent" class="form-label">Message</label>
                        <textarea class="form-control" id="messageContent" name="content" rows="4" 
                                  placeholder="Share with your cohort..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitMessage()">
                    <i class="bi bi-send me-1"></i>Post Message
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function showProgressModal() {
    const modal = new bootstrap.Modal(document.getElementById('progressModal'));
    modal.show();
}

function showMessageModal() {
    const modal = new bootstrap.Modal(document.getElementById('messageModal'));
    modal.show();
}

function updateProgressLabel(value) {
    document.getElementById('progressLabel').textContent = value + '%';
}

async function submitProgress() {
    const form = document.getElementById('progressForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch('/collective_actions/update_progress', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
            modal.hide();
            
            showToast('success', 'Progress updated successfully!');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('error', result.error || 'Failed to update progress');
        }
    } catch (error) {
        showToast('error', 'Failed to update progress');
    }
}

async function submitMessage() {
    const form = document.getElementById('messageForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch('/collective_actions/post_message', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('messageModal'));
            modal.hide();
            
            showToast('success', 'Message posted successfully!');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('error', result.error || 'Failed to post message');
        }
    } catch (error) {
        showToast('error', 'Failed to post message');
    }
}

function showToast(type, message) {
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div class="toast align-items-center text-bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert" id="${toastId}">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1055';
    document.body.appendChild(container);
    return container;
}
</script>

{% endblock %}