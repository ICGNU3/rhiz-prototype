{% extends "base.html" %}

{% block title %}AI Assistant - OuRhizome{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- AI Assistant Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h1 class="h3 mb-1">AI Assistant</h1>
                    <p class="text-muted">Ambient intelligence surfacing connections, actions, and insights</p>
                </div>
                <div class="ai-status-indicator">
                    <i class="bi bi-cpu text-success"></i>
                    <small class="text-muted ms-1">Active</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Missed Connections Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card ai-card missed-connections-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-people me-2 text-primary"></i>
                        <h5 class="mb-0">Missed Connections</h5>
                    </div>
                    <span class="badge bg-primary rounded-pill" id="connectionsCount">{{ assistant_data.missed_connections|length }}</span>
                </div>
                <div class="card-body">
                    {% if assistant_data.missed_connections %}
                        <div class="row" id="missedConnectionsContainer">
                            {% for connection in assistant_data.missed_connections %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="connection-card">
                                    <div class="connection-header mb-2">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="connection-info">
                                                <h6 class="mb-1">Potential Connection</h6>
                                                <small class="text-muted">{{ (connection.confidence * 100)|round }}% match</small>
                                            </div>
                                            <div class="confidence-indicator">
                                                <div class="confidence-bar">
                                                    <div class="confidence-fill" style="width: {{ (connection.confidence * 100)|round }}%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="connection-content">
                                        <p class="connection-reason mb-2">{{ connection.reason }}</p>
                                        <div class="connection-suggestion p-2 bg-light rounded">
                                            <small class="text-muted d-block mb-1">Suggested intro:</small>
                                            <em>"{{ connection.suggestion }}"</em>
                                        </div>
                                    </div>
                                    <div class="connection-actions mt-3">
                                        <button class="btn btn-primary btn-sm me-2" 
                                                onclick="makeIntroduction({{ connection.id }})">
                                            <i class="bi bi-envelope me-1"></i>Make Intro
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" 
                                                onclick="dismissConnection({{ connection.id }})">
                                            <i class="bi bi-x me-1"></i>Not Now
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state text-center py-4">
                            <i class="bi bi-search text-muted" style="font-size: 2rem;"></i>
                            <p class="text-muted mt-2">No missed connections detected right now</p>
                            <small class="text-muted">I'm analyzing your network for valuable opportunities...</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Micro-Actions Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card ai-card micro-actions-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-lightning me-2 text-warning"></i>
                        <h5 class="mb-0">Today's Micro-Actions</h5>
                    </div>
                    <span class="badge bg-warning rounded-pill" id="actionsCount">{{ assistant_data.daily_actions|length }}</span>
                </div>
                <div class="card-body">
                    {% if assistant_data.daily_actions %}
                        <div class="actions-list" id="microActionsContainer">
                            {% for action in assistant_data.daily_actions %}
                            <div class="action-item mb-3" data-action-id="{{ loop.index }}">
                                <div class="d-flex align-items-start">
                                    <div class="action-type-icon me-3">
                                        {% if action.type == 'outreach' %}
                                            <i class="bi bi-send text-primary"></i>
                                        {% elif action.type == 'research' %}
                                            <i class="bi bi-search text-info"></i>
                                        {% elif action.type == 'follow_up' %}
                                            <i class="bi bi-clock text-success"></i>
                                        {% else %}
                                            <i class="bi bi-lightbulb text-warning"></i>
                                        {% endif %}
                                    </div>
                                    <div class="action-content flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="action-title mb-1">{{ action.suggestion }}</h6>
                                            <div class="action-meta">
                                                <span class="badge bg-light text-dark">{{ action.time }}</span>
                                                <div class="priority-indicator ms-2">
                                                    {% for i in range((action.priority * 5)|round|int) %}
                                                        <i class="bi bi-star-fill text-warning"></i>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        <p class="action-context text-muted mb-2">{{ action.context }}</p>
                                        <div class="action-actions">
                                            <button class="btn btn-success btn-sm me-2" 
                                                    onclick="completeAction({{ loop.index }})">
                                                <i class="bi bi-check me-1"></i>Done
                                            </button>
                                            <button class="btn btn-outline-primary btn-sm me-2" 
                                                    onclick="expandAction({{ loop.index }})">
                                                <i class="bi bi-info-circle me-1"></i>Details
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm" 
                                                    onclick="snoozeAction({{ loop.index }})">
                                                <i class="bi bi-clock me-1"></i>Later
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state text-center py-4">
                            <i class="bi bi-check-circle text-muted" style="font-size: 2rem;"></i>
                            <p class="text-muted mt-2">All caught up! No actions needed right now</p>
                            <small class="text-muted">I'll suggest new actions as opportunities arise...</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Weekly Collective Insights Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card ai-card insights-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-graph-up me-2 text-success"></i>
                        <h5 class="mb-0">Weekly Collective Insights</h5>
                    </div>
                    <span class="badge bg-success rounded-pill">{{ assistant_data.weekly_insights|length }}</span>
                </div>
                <div class="card-body">
                    {% if assistant_data.weekly_insights %}
                        {% for insight in assistant_data.weekly_insights %}
                        <div class="insight-item mb-4">
                            <div class="insight-header d-flex align-items-center mb-3">
                                <div class="insight-icon me-3">
                                    {% if insight.type == 'funding_trends' %}
                                        <i class="bi bi-cash-stack text-success"></i>
                                    {% elif insight.type == 'networking_patterns' %}
                                        <i class="bi bi-people text-primary"></i>
                                    {% else %}
                                        <i class="bi bi-diagram-3 text-info"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <h6 class="mb-1">{{ insight.title }}</h6>
                                    <small class="text-muted">{{ insight.type.replace('_', ' ').title() }}</small>
                                </div>
                            </div>
                            <div class="insight-content">
                                <p class="insight-description mb-3">{{ insight.description }}</p>
                                <div class="insight-recommendation p-3 bg-light rounded">
                                    <div class="d-flex align-items-start">
                                        <i class="bi bi-lightbulb text-warning me-2 mt-1"></i>
                                        <div>
                                            <strong class="d-block mb-1">Recommended Action:</strong>
                                            <span>{{ insight.recommendation }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state text-center py-4">
                            <i class="bi bi-graph-up text-muted" style="font-size: 2rem;"></i>
                            <p class="text-muted mt-2">Generating this week's insights...</p>
                            <small class="text-muted">Check back tomorrow for collective network trends</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- AI Assistant Controls -->
    <div class="row">
        <div class="col-12">
            <div class="card ai-controls-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Assistant Preferences</h6>
                            <small class="text-muted">Customize how your AI assistant works</small>
                        </div>
                        <div class="d-flex gap-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="connectionsEnabled" checked>
                                <label class="form-check-label" for="connectionsEnabled">
                                    Connection suggestions
                                </label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="actionsEnabled" checked>
                                <label class="form-check-label" for="actionsEnabled">
                                    Daily actions
                                </label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="insightsEnabled" checked>
                                <label class="form-check-label" for="insightsEnabled">
                                    Weekly insights
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Details Modal -->
<div class="modal fade" id="actionDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Action Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="actionDetailsContent">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="completeActionFromModal()">
                    <i class="bi bi-check me-1"></i>Mark Complete
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* AI Assistant Styling */
.ai-card {
    border: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-radius: 16px;
    overflow: hidden;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.ai-card .card-header {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 100%);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 1rem 1.5rem;
}

.ai-status-indicator {
    display: flex;
    align-items: center;
}

.ai-status-indicator i {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Missed Connections */
.connection-card {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 12px;
    padding: 1rem;
    border: 1px solid rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.connection-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.confidence-bar {
    width: 60px;
    height: 4px;
    background: #e9ecef;
    border-radius: 2px;
    overflow: hidden;
}

.confidence-fill {
    height: 100%;
    background: linear-gradient(90deg, #ffc107 0%, #28a745 100%);
    transition: width 0.3s ease;
}

.connection-suggestion {
    font-style: italic;
    border-left: 3px solid #007bff;
}

/* Micro-Actions */
.action-item {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 12px;
    padding: 1rem;
    border: 1px solid rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.action-item:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.action-type-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.8);
    font-size: 1.2rem;
}

.priority-indicator {
    display: flex;
    gap: 2px;
}

.priority-indicator i {
    font-size: 0.7rem;
}

/* Weekly Insights */
.insight-item {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.insight-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.8);
    font-size: 1.2rem;
}

.insight-recommendation {
    border-left: 4px solid #28a745;
}

/* Empty States */
.empty-state {
    opacity: 0.7;
}

/* Controls */
.ai-controls-card {
    background: linear-gradient(135deg, rgba(108, 117, 125, 0.1) 0%, rgba(108, 117, 125, 0.05) 100%);
}

.form-check-input:checked {
    background-color: #28a745;
    border-color: #28a745;
}

/* Responsive Design */
@media (max-width: 768px) {
    .connection-card, .action-item, .insight-item {
        margin-bottom: 1rem;
    }
    
    .action-meta {
        flex-direction: column;
        align-items: flex-end;
        gap: 0.5rem;
    }
    
    .d-flex.gap-3 {
        flex-direction: column;
        gap: 1rem !important;
    }
}

/* Loading States */
.loading-shimmer {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}
</style>

<script>
// AI Assistant JavaScript Functions

let currentActionId = null;

// Connection Management
function makeIntroduction(connectionId) {
    // Show confirmation and send introduction
    if (confirm('Send this introduction? This will connect both members and mark the suggestion as acted upon.')) {
        fetch('/api/ai-assistant/connection/act', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ connection_id: connectionId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Introduction sent successfully!', 'success');
                refreshConnections();
            } else {
                showToast('Failed to send introduction', 'error');
            }
        })
        .catch(error => showToast('Error sending introduction', 'error'));
    }
}

function dismissConnection(connectionId) {
    fetch('/api/ai-assistant/connection/dismiss', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ connection_id: connectionId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Connection dismissed', 'info');
            refreshConnections();
        }
    });
}

// Action Management
function completeAction(actionId) {
    fetch('/api/ai-assistant/action/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action_id: actionId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Action completed! +5 XP', 'success');
            markActionAsCompleted(actionId);
            refreshActions();
        }
    });
}

function expandAction(actionId) {
    currentActionId = actionId;
    // Get detailed action information
    fetch(`/api/ai-assistant/action/${actionId}/details`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayActionDetails(data.action);
            }
        });
}

function snoozeAction(actionId) {
    fetch('/api/ai-assistant/action/snooze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action_id: actionId, hours: 4 })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Action snoozed for 4 hours', 'info');
            hideAction(actionId);
        }
    });
}

function completeActionFromModal() {
    if (currentActionId) {
        completeAction(currentActionId);
        bootstrap.Modal.getInstance(document.getElementById('actionDetailsModal')).hide();
    }
}

// UI Updates
function markActionAsCompleted(actionId) {
    const actionElement = document.querySelector(`[data-action-id="${actionId}"]`);
    if (actionElement) {
        actionElement.style.opacity = '0.6';
        actionElement.querySelector('.action-title').innerHTML += ' <i class="bi bi-check-circle text-success"></i>';
        setTimeout(() => {
            actionElement.style.display = 'none';
        }, 2000);
    }
}

function hideAction(actionId) {
    const actionElement = document.querySelector(`[data-action-id="${actionId}"]`);
    if (actionElement) {
        actionElement.style.transition = 'all 0.3s ease';
        actionElement.style.opacity = '0';
        actionElement.style.transform = 'translateX(-100%)';
        setTimeout(() => {
            actionElement.style.display = 'none';
        }, 300);
    }
}

function displayActionDetails(action) {
    const content = `
        <div class="action-details">
            <h6>Action Type: <span class="badge bg-primary">${action.type}</span></h6>
            <p><strong>Suggestion:</strong> ${action.suggestion}</p>
            <p><strong>Context:</strong> ${action.context}</p>
            <p><strong>Goal Relevance:</strong> ${action.goal_relevance}</p>
            <p><strong>Estimated Time:</strong> ${action.time}</p>
            <div class="priority-display">
                <strong>Priority:</strong>
                <div class="priority-stars ms-2">
                    ${Array(Math.round(action.priority * 5)).fill().map(() => '<i class="bi bi-star-fill text-warning"></i>').join('')}
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('actionDetailsContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('actionDetailsModal')).show();
}

// Refresh Functions
function refreshConnections() {
    fetch('/api/ai-assistant/connections/refresh')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Simple refresh for now
            }
        });
}

function refreshActions() {
    fetch('/api/ai-assistant/actions/refresh')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateActionsDisplay(data.actions);
            }
        });
}

function updateActionsDisplay(actions) {
    const container = document.getElementById('microActionsContainer');
    const count = document.getElementById('actionsCount');
    
    count.textContent = actions.length;
    
    if (actions.length === 0) {
        container.innerHTML = `
            <div class="empty-state text-center py-4">
                <i class="bi bi-check-circle text-muted" style="font-size: 2rem;"></i>
                <p class="text-muted mt-2">All caught up! No actions needed right now</p>
                <small class="text-muted">I'll suggest new actions as opportunities arise...</small>
            </div>
        `;
    }
}

// Toast Notifications
function showToast(message, type = 'info') {
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();
    const toast = createToast(message, type);
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    container.style.zIndex = '1050';
    document.body.appendChild(container);
    return container;
}

function createToast(message, type) {
    const colors = {
        success: 'text-bg-success',
        error: 'text-bg-danger',
        info: 'text-bg-info',
        warning: 'text-bg-warning'
    };
    
    const toast = document.createElement('div');
    toast.className = `toast ${colors[type] || colors.info}`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    return toast;
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh every 5 minutes
    setInterval(() => {
        refreshConnections();
        refreshActions();
    }, 5 * 60 * 1000);
    
    // Save preferences when toggles change
    document.querySelectorAll('.form-check-input').forEach(toggle => {
        toggle.addEventListener('change', function() {
            const preferences = {
                connections: document.getElementById('connectionsEnabled').checked,
                actions: document.getElementById('actionsEnabled').checked,
                insights: document.getElementById('insightsEnabled').checked
            };
            
            fetch('/api/ai-assistant/preferences', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(preferences)
            });
        });
    });
});
</script>

{% endblock %}