<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Setup - OuRhizome</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/placeholder">
</head>
<body>
    {% include 'components/navigation.html' %}
    
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Header -->
                <div class="text-center mb-5">
                    <h1 class="h2 mb-3">Email Configuration</h1>
                    <p class="text-body-secondary">Configure your email settings to send AI-generated messages directly from OuRhizome</p>
                </div>
                
                <!-- Configuration Status -->
                <div class="card glass-card mb-4">
                    <div class="card-body">
                        <h5 class="card-title d-flex align-items-center">
                            <i class="bi bi-gear-fill me-2"></i>
                            Configuration Status
                        </h5>
                        
                        {% if config_status.configured %}
                            <div class="alert alert-success d-flex align-items-center">
                                <i class="bi bi-check-circle-fill me-2"></i>
                                Email configured successfully for {{ config_status.email_address }}
                            </div>
                        {% else %}
                            <div class="alert alert-warning d-flex align-items-center">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                Email configuration incomplete
                            </div>
                        {% endif %}
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-envelope me-2 {% if config_status.email_address %}text-success{% else %}text-warning{% endif %}"></i>
                                    <span>Email Address: {{ config_status.email_address or 'Not configured' }}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-server me-2 {% if config_status.smtp_server %}text-success{% else %}text-warning{% endif %}"></i>
                                    <span>Provider: {{ config_status.provider.title() }}</span>
                                </div>
                            </div>
                        </div>
                        
                        {% if config_status.configured %}
                            <div class="mt-3">
                                <button type="button" class="btn btn-outline-primary" onclick="testConnection()">
                                    <i class="bi bi-wifi me-2"></i>Test Connection
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Setup Instructions -->
                {% if not config_status.configured %}
                <div class="card glass-card mb-4">
                    <div class="card-body">
                        <h5 class="card-title d-flex align-items-center">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            Setup Instructions
                        </h5>
                        
                        <p>To enable direct email sending, you need to configure these environment variables:</p>
                        
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Variable</th>
                                        <th>Description</th>
                                        <th>Example</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>EMAIL_ADDRESS</code></td>
                                        <td>Your email address</td>
                                        <td>founder@example.com</td>
                                    </tr>
                                    <tr>
                                        <td><code>EMAIL_PASSWORD</code></td>
                                        <td>App password (not regular password)</td>
                                        <td>Generated app password</td>
                                    </tr>
                                    <tr>
                                        <td><code>SENDER_NAME</code></td>
                                        <td>Display name (optional)</td>
                                        <td>John Founder</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="accordion mt-4" id="providerInstructions">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#gmailInstructions">
                                        <i class="bi bi-google me-2"></i>Gmail Setup
                                    </button>
                                </h2>
                                <div id="gmailInstructions" class="accordion-collapse collapse" data-bs-parent="#providerInstructions">
                                    <div class="accordion-body">
                                        <ol>
                                            <li>Enable 2-factor authentication on your Google account</li>
                                            <li>Go to Google Account settings → Security → App passwords</li>
                                            <li>Generate an app password for "Mail"</li>
                                            <li>Use your Gmail address and the generated app password</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#outlookInstructions">
                                        <i class="bi bi-microsoft me-2"></i>Outlook Setup
                                    </button>
                                </h2>
                                <div id="outlookInstructions" class="accordion-collapse collapse" data-bs-parent="#providerInstructions">
                                    <div class="accordion-body">
                                        <ol>
                                            <li>Sign in to your Microsoft account</li>
                                            <li>Go to Security → Advanced security options</li>
                                            <li>Create an app password</li>
                                            <li>Use your Outlook email and the generated app password</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Email Templates -->
                <div class="card glass-card">
                    <div class="card-body">
                        <h5 class="card-title d-flex align-items-center">
                            <i class="bi bi-file-text-fill me-2"></i>
                            Email Templates
                        </h5>
                        <p class="text-body-secondary">Pre-configured templates for different outreach scenarios</p>
                        
                        <div class="row g-3">
                            {% for template in templates %}
                            <div class="col-md-6">
                                <div class="card border-secondary">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ template.name }}</h6>
                                        <p class="card-text small text-body-secondary">{{ template.subject }}</p>
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#templateModal{{ loop.index }}">
                                            View Template
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Template Modal -->
                            <div class="modal fade" id="templateModal{{ loop.index }}" tabindex="-1">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">{{ template.name }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <label class="form-label">Subject:</label>
                                                <input type="text" class="form-control" value="{{ template.subject }}" readonly>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Template:</label>
                                                <textarea class="form-control" rows="10" readonly>{{ template.template }}</textarea>
                                            </div>
                                            <div class="alert alert-info">
                                                <small>Variables like {contact_name}, {company}, and {goal_title} will be automatically replaced when sending.</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Test Connection Modal -->
    <div class="modal fade" id="testResultModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Connection Test</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="testResult"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function testConnection() {
            const testResult = document.getElementById('testResult');
            testResult.innerHTML = '<div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm me-2"></div>Testing connection...</div>';
            
            const modal = new bootstrap.Modal(document.getElementById('testResultModal'));
            modal.show();
            
            try {
                const response = await fetch('/test_email_connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    testResult.innerHTML = `
                        <div class="alert alert-success d-flex align-items-center">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            ${result.message}
                        </div>
                    `;
                } else {
                    testResult.innerHTML = `
                        <div class="alert alert-danger d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            ${result.error}
                        </div>
                    `;
                }
            } catch (error) {
                testResult.innerHTML = `
                    <div class="alert alert-danger d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Connection test failed: ${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>