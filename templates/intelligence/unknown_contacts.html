{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">Unknown but Important Contacts</h1>
                    <p class="text-muted">Identify and organize contacts you remember but can't quite place</p>
                </div>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUnknownModal">
                        <i class="bi bi-plus me-2"></i>Add Unknown Contact
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Instructions -->
    <div class="alert alert-info mb-4">
        <div class="d-flex">
            <div class="flex-shrink-0">
                <i class="bi bi-info-circle"></i>
            </div>
            <div class="flex-grow-1 ms-3">
                <h6 class="alert-heading">How it works:</h6>
                <p class="mb-0">
                    Add names, phone numbers, or identifiers for people you remember but can't fully identify. 
                    Our AI will analyze context clues and suggest potential connections based on your network and activities.
                </p>
            </div>
        </div>
    </div>

    <!-- Unknown Contacts List -->
    <div class="row">
        {% if unknown_contacts %}
        {% for unknown in unknown_contacts %}
        <div class="col-lg-6 mb-4">
            <div class="card h-100" data-unknown-id="{{ unknown.id }}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title mb-0">{{ unknown.identifier }}</h5>
                        <small class="text-muted">{{ unknown.identifier_type|title }}</small>
                    </div>
                    <span class="badge bg-{{ 'success' if unknown.status == 'identified' else 'warning' if unknown.status == 'investigating' else 'secondary' }}">
                        {{ unknown.status|title }}
                    </span>
                </div>
                <div class="card-body">
                    <!-- Context Clues -->
                    {% if unknown.context_clues %}
                    <div class="mb-3">
                        <h6>Context Clues:</h6>
                        <ul class="list-unstyled small">
                            {% for clue in unknown.context_clues %}
                            <li><i class="bi bi-arrow-right text-primary me-1"></i>{{ clue }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- AI Suggestions -->
                    {% if unknown.ai_suggestions %}
                    <div class="mb-3">
                        <h6>AI Suggestions:</h6>
                        
                        {% if unknown.ai_suggestions.get('questions') %}
                        <div class="mb-2">
                            <strong class="small text-info">Questions to help identify:</strong>
                            <ul class="list-unstyled small mt-1">
                                {% for question in unknown.ai_suggestions.questions[:3] %}
                                <li class="text-muted">â€¢ {{ question }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        {% if unknown.ai_suggestions.get('events') %}
                        <div class="mb-2">
                            <strong class="small text-success">Possible events:</strong>
                            <div class="small text-muted">{{ unknown.ai_suggestions.events|join()</div>
                        </div>
                        {% endif %}

                        {% if unknown.ai_suggestions.get('connections') %}
                        <div class="mb-2">
                            <strong class="small text-warning">Potential connections:</strong>
                            <div class="small text-muted">{{ unknown.ai_suggestions.connections|join()</div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Notes -->
                    {% if unknown.notes %}
                    <div class="mb-3">
                        <h6>Notes:</h6>
                        <p class="small text-muted">{{ unknown.notes }}</p>
                    </div>
                    {% endif %}

                    <!-- Review Info -->
                    <div class="small text-muted mb-3">
                        <div>Added: {{ unknown.created_at|format_datetime }}</div>
                        {% if unknown.review_count > 0 %}
                        <div>Reviewed {{ unknown.review_count }} time{{ 's' if unknown.review_count != 1 else '' }}</div>
                        {% endif %}
                    </div>
                </div>
                
                {% if unknown.status == 'unknown' %}
                <div class="card-footer">
                    <div class="btn-group w-100">
                        <button class="btn btn-outline-success btn-sm" onclick="reviewUnknownContact('{{ unknown.id }}', 'identified')">
                            <i class="bi bi-check me-1"></i>Identified
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="reviewUnknownContact('{{ unknown.id }}', 'investigating')">
                            <i class="bi bi-search me-1"></i>Investigating
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="reviewUnknownContact('{{ unknown.id }}', 'irrelevant')">
                            <i class="bi bi-x me-1"></i>Irrelevant
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        
        {% else %}
        <!-- Empty State -->
        <div class="col-12">
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="bi bi-question-circle display-1 text-muted"></i>
                </div>
                <h4>No Unknown Contacts Yet</h4>
                <p class="text-muted mb-4">
                    Start adding names, phone numbers, or other identifiers for people you remember but can't quite place.
                </p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUnknownModal">
                    <i class="bi bi-plus me-2"></i>Add Your First Unknown Contact
                </button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Unknown Contact Modal -->
<div class="modal fade" id="addUnknownModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Unknown Contact</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUnknownForm">
                    <div class="mb-3">
                        <label for="identifier" class="form-label">Identifier *</label>
                        <input type="text" class="form-control" id="identifier" placeholder="e.g., John, +1-555-0123, @johndoe" required>
                        <div class="form-text">Enter a name, phone number, email, or social handle</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="identifierType" class="form-label">Type</label>
                        <select class="form-select" id="identifierType">
                            <option value="name">Name</option>
                            <option value="phone">Phone Number</option>
                            <option value="email">Email</option>
                            <option value="handle">Social Handle</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="contextClues" class="form-label">Context Clues</label>
                        <textarea class="form-control" id="contextClues" rows="3" 
                                  placeholder="e.g., Met at TechCrunch, works in fintech, knows Sarah from my last company"></textarea>
                        <div class="form-text">Any details that might help identify this person (optional)</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addUnknownContact()">Add Contact</button>
            </div>
        </div>
    </div>
</div>

<script>
function addUnknownContact() {
    const identifier = document.getElementById('identifier').value.trim();
    const identifierType = document.getElementById('identifierType').value;
    const contextCluesText = document.getElementById('contextClues').value.trim();
    
    if (!identifier) {
        showToast('Please enter an identifier', 'error');
        return;
    }
    
    // Parse context clues into array
    const contextClues = contextCluesText ? 
        contextCluesText.split(/[,\n]/).map(s => s.trim()).filter(s => s.length > 0) : [];
    
    // Show loading state
    const btn = event.target;
    const originalText = btn.textContent;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Adding...';
    btn.disabled = true;
    
    fetch('/api/unknown-contacts/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            identifier: identifier,
            identifier_type: identifierType,
            context_clues: contextClues
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Unknown contact added successfully! AI is analyzing...', 'success');
            
            // Close modal and reload page
            const modal = bootstrap.Modal.getInstance(document.getElementById('addUnknownModal'));
            modal.hide();
            
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showToast(data.error || 'Failed to add unknown contact', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to add unknown contact', 'error');
    })
    .finally(() => {
        // Restore button
        btn.textContent = originalText;
        btn.disabled = false;
    });
}

function reviewUnknownContact(unknownId, action) {
    let notes = '';
    
    // Get notes from user for certain actions
    if (action === 'identified') {
        notes = prompt('Who is this contact? (Optional - add any identification notes):') || '';
    } else if (action === 'investigating') {
        notes = prompt('What are you investigating? (Optional - add research notes):') || '';
    }
    
    fetch(`/api/unknown-contacts/${unknownId}/review`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            action: action,
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the card
            const card = document.querySelector(`[data-unknown-id="${unknownId}"]`);
            if (card) {
                const badge = card.querySelector('.badge');
                const footer = card.querySelector('.card-footer');
                
                // Update badge
                badge.className = `badge bg-${action === 'identified' ? 'success' : action === 'investigating' ? 'warning' : 'danger'}`;
                badge.textContent = action.charAt(0).toUpperCase() + action.slice(1);
                
                // Remove footer if not unknown anymore
                if (action !== 'unknown' && footer) {
                    footer.remove();
                }
                
                // Add fade effect
                card.style.opacity = '0.7';
                setTimeout(() => {
                    card.style.opacity = '1';
                }, 500);
            }
            
            showToast(`Contact marked as ${action}`, 'success');
        } else {
            showToast(data.error || 'Failed to review contact', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to review contact', 'error');
    });
}

function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    // Add to toast container
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(container);
    }
    
    container.appendChild(toast);
    
    // Show toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove after hiding
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

// Clear form when modal is hidden
document.getElementById('addUnknownModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('addUnknownForm').reset();
});
</script>
{% endblock %}