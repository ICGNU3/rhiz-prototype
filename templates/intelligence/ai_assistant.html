{% extends "base.html" %}

{% block title %}AI Assistant - OuRhizome{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="bi bi-cpu me-2 text-primary"></i>AI Assistant
                    </h1>
                    <p class="text-muted mb-0">Ambient intelligence surfacing missed connections and daily micro-actions</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshConnections()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh Connections
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="refreshActions()">
                        <i class="bi bi-lightning me-1"></i>Refresh Actions
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Missed Connections Column -->
        <div class="col-lg-4">
            <div class="card h-100 glass-card">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-people me-2 text-info"></i>Missed Connections
                    </h5>
                    <span class="badge bg-info">{{ assistant_data.missed_connections|length }}</span>
                </div>
                <div class="card-body">
                    {% if assistant_data.missed_connections %}
                        <div class="connections-list">
                            {% for connection in assistant_data.missed_connections %}
                            <div class="connection-card mb-3 p-3 border rounded">
                                <div class="d-flex align-items-start justify-content-between mb-2">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ connection.name or 'Root Member' }}</h6>
                                        <small class="text-muted">{{ connection.company or 'Startup' }}</small>
                                    </div>
                                    <span class="badge bg-success">{{ "%.0f"|format(connection.confidence_score * 100) }}%</span>
                                </div>
                                <p class="mb-2 small">{{ connection.connection_reason }}</p>
                                <div class="connection-suggestion mb-3">
                                    <small class="text-muted d-block mb-1">Suggested intro:</small>
                                    <p class="small mb-0 fst-italic">"{{ connection.suggested_intro }}"</p>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary btn-sm flex-grow-1" 
                                            onclick="actOnConnection({{ connection.user_b_id }})">
                                        <i class="bi bi-check-circle me-1"></i>Make Connection
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" 
                                            onclick="dismissConnection({{ connection.user_b_id }})">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-search display-6 text-muted mb-3"></i>
                            <p class="text-muted">No missed connections detected today.</p>
                            <p class="small text-muted">AI analyzes your goals and activities to surface potential connections with other Root Members.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Daily Micro-Actions Column -->
        <div class="col-lg-4">
            <div class="card h-100 glass-card">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightning me-2 text-warning"></i>Daily Micro-Actions
                    </h5>
                    <span class="badge bg-warning">{{ assistant_data.daily_actions|length }}</span>
                </div>
                <div class="card-body">
                    {% if assistant_data.daily_actions %}
                        <div class="actions-list">
                            {% for action in assistant_data.daily_actions %}
                            <div class="action-card mb-3 p-3 border rounded">
                                <div class="d-flex align-items-start justify-content-between mb-2">
                                    <div class="flex-grow-1">
                                        <span class="badge bg-{{ 'danger' if action.priority_score > 0.8 else 'warning' if action.priority_score > 0.5 else 'secondary' }} mb-2">
                                            {{ action.action_type.replace('_', ' ').title() }}
                                        </span>
                                        <h6 class="mb-1">{{ action.suggestion }}</h6>
                                    </div>
                                    <small class="text-muted">{{ action.estimated_time }}</small>
                                </div>
                                <p class="mb-2 small text-muted">{{ action.context }}</p>
                                {% if action.goal_relevance %}
                                <div class="goal-relevance mb-3">
                                    <small class="text-info d-block mb-1">Goal relevance:</small>
                                    <p class="small mb-0">{{ action.goal_relevance }}</p>
                                </div>
                                {% endif %}
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success btn-sm flex-grow-1" 
                                            onclick="completeMicroAction({{ action.id or 1 }})">
                                        <i class="bi bi-check2 me-1"></i>Complete
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" 
                                            onclick="snoozeMicroAction({{ action.id or 1 }}, 4)">
                                        <i class="bi bi-clock me-1"></i>4h
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-lightning display-6 text-muted mb-3"></i>
                            <p class="text-muted">No micro-actions generated today.</p>
                            <p class="small text-muted">AI creates small, actionable steps based on your goals and recent networking activity.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Weekly Collective Insights Column -->
        <div class="col-lg-4">
            <div class="card h-100 glass-card">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-graph-up me-2 text-success"></i>Weekly Insights
                    </h5>
                    <span class="badge bg-success">{{ assistant_data.weekly_insights|length }}</span>
                </div>
                <div class="card-body">
                    {% if assistant_data.weekly_insights %}
                        <div class="insights-list">
                            {% for insight in assistant_data.weekly_insights %}
                            <div class="insight-card mb-3 p-3 border rounded">
                                <div class="d-flex align-items-start justify-content-between mb-2">
                                    <div class="flex-grow-1">
                                        <span class="badge bg-{{ 'success' if insight.trend_direction == 'up' else 'warning' if insight.trend_direction == 'stable' else 'secondary' }} mb-2">
                                            {{ insight.insight_type.replace('_', ' ').title() }}
                                        </span>
                                        <h6 class="mb-1">{{ insight.title }}</h6>
                                    </div>
                                    <span class="badge bg-outline-{{ 'success' if insight.impact_level == 'high' else 'warning' if insight.impact_level == 'medium' else 'secondary' }}">
                                        {{ insight.impact_level.title() }}
                                    </span>
                                </div>
                                <p class="mb-2 small">{{ insight.description }}</p>
                                {% if insight.data_points %}
                                <div class="data-points mb-3">
                                    <small class="text-muted d-block mb-1">Key data:</small>
                                    {% for point in insight.data_points[:2] %}
                                    <div class="small d-flex justify-content-between">
                                        <span>{{ point.metric }}</span>
                                        <strong>{{ point.value }}</strong>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% if insight.actionable_recommendation %}
                                <div class="recommendation">
                                    <small class="text-primary d-block mb-1">Recommendation:</small>
                                    <p class="small mb-0 text-primary">{{ insight.actionable_recommendation }}</p>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-graph-up display-6 text-muted mb-3"></i>
                            <p class="text-muted">Weekly insights will appear here.</p>
                            <p class="small text-muted">AI analyzes community trends and provides collective intelligence about the Root Member ecosystem.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Assistant Preferences -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card glass-card">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1">AI Assistant Preferences</h6>
                            <p class="text-muted mb-0 small">Configure how ambient intelligence surfaces insights and suggestions</p>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm" onclick="openAssistantSettings()">
                            <i class="bi bi-gear me-1"></i>Configure
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// AI Assistant JavaScript functionality
function actOnConnection(connectionId) {
    fetch('/api/ai-assistant/connection/act', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ connection_id: connectionId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Connection action recorded! XP awarded.', 'success');
            // Remove the connection card
            event.target.closest('.connection-card').style.opacity = '0.5';
            event.target.disabled = true;
            event.target.innerHTML = '<i class="bi bi-check me-1"></i>Done';
        } else {
            showToast('Failed to record action. Please try again.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Network error. Please try again.', 'error');
    });
}

function dismissConnection(connectionId) {
    fetch('/api/ai-assistant/connection/dismiss', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ connection_id: connectionId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the connection card with animation
            const card = event.target.closest('.connection-card');
            card.style.transition = 'opacity 0.3s ease';
            card.style.opacity = '0';
            setTimeout(() => card.remove(), 300);
        }
    })
    .catch(error => console.error('Error:', error));
}

function completeMicroAction(actionId) {
    fetch('/api/ai-assistant/action/complete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ action_id: actionId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Micro-action completed! XP awarded.', 'success');
            // Update the action card
            event.target.closest('.action-card').style.opacity = '0.5';
            event.target.disabled = true;
            event.target.innerHTML = '<i class="bi bi-check me-1"></i>Completed';
        } else {
            showToast('Failed to complete action. Please try again.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Network error. Please try again.', 'error');
    });
}

function snoozeMicroAction(actionId, hours) {
    fetch('/api/ai-assistant/action/snooze', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ action_id: actionId, hours: hours })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Action snoozed for ${hours} hours`, 'info');
            // Fade out the action card
            const card = event.target.closest('.action-card');
            card.style.transition = 'opacity 0.3s ease';
            card.style.opacity = '0.3';
        }
    })
    .catch(error => console.error('Error:', error));
}

function refreshConnections() {
    const button = event.target;
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-arrow-clockwise spinner-border spinner-border-sm me-1"></i>Refreshing...';
    
    fetch('/api/ai-assistant/connections/refresh')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Connections refreshed successfully', 'success');
            // Reload the page to show new connections
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('Failed to refresh connections', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Network error refreshing connections', 'error');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Refresh Connections';
    });
}

function refreshActions() {
    const button = event.target;
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-lightning spinner-border spinner-border-sm me-1"></i>Refreshing...';
    
    fetch('/api/ai-assistant/actions/refresh')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Actions refreshed successfully', 'success');
            // Reload the page to show new actions
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('Failed to refresh actions', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Network error refreshing actions', 'error');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-lightning me-1"></i>Refresh Actions';
    });
}

function openAssistantSettings() {
    const modalHtml = `
        <div class="modal fade" id="assistantSettingsModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">AI Assistant Preferences</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Connection Discovery</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enableConnections" checked>
                                <label class="form-check-label" for="enableConnections">
                                    Surface missed connections with other Root Members
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Daily Micro-Actions</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enableActions" checked>
                                <label class="form-check-label" for="enableActions">
                                    Generate goal-focused daily actions
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Weekly Collective Insights</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enableInsights" checked>
                                <label class="form-check-label" for="enableInsights">
                                    Share community trends and patterns
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notification Frequency</label>
                            <select class="form-select" id="notificationFreq">
                                <option value="realtime">Real-time</option>
                                <option value="daily" selected>Daily digest</option>
                                <option value="weekly">Weekly summary</option>
                                <option value="manual">Manual only</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveAssistantSettings()">Save Preferences</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('assistantSettingsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body and show
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    new bootstrap.Modal(document.getElementById('assistantSettingsModal')).show();
}

function saveAssistantSettings() {
    const preferences = {
        connections_enabled: document.getElementById('enableConnections').checked,
        actions_enabled: document.getElementById('enableActions').checked,
        insights_enabled: document.getElementById('enableInsights').checked,
        notification_frequency: document.getElementById('notificationFreq').value
    };
    
    fetch('/api/ai-assistant/preferences', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(preferences)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('AI Assistant preferences saved', 'success');
            bootstrap.Modal.getInstance(document.getElementById('assistantSettingsModal')).hide();
        } else {
            showToast('Failed to save preferences', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Network error saving preferences', 'error');
    });
}

function showToast(message, type = 'info') {
    // Create toast element
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    // Add toast container if not exists
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    // Add and show toast
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = toastContainer.lastElementChild;
    new bootstrap.Toast(toastElement).show();
    
    // Remove toast after it's hidden
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}
</script>
{% endblock %}