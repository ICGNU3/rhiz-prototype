{% extends "base.html" %}

{% block title %}Network Visualization - Founder Network AI{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-diagram-3 me-2"></i>Network Visualization</h2>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-light" onclick="refreshNetwork()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                    <button type="button" class="btn btn-outline-light" onclick="exportNetwork()">
                        <i class="bi bi-download me-1"></i>Export
                    </button>
                    <button type="button" class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#addRelationshipModal">
                        <i class="bi bi-plus-circle me-1"></i>Add Relationship
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Metrics Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-dark border-secondary">
                <div class="card-body text-center">
                    <h3 class="text-info mb-1" id="totalContacts">0</h3>
                    <small class="text-muted">Total Contacts</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-secondary">
                <div class="card-body text-center">
                    <h3 class="text-success mb-1" id="totalRelationships">0</h3>
                    <small class="text-muted">Relationships</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-secondary">
                <div class="card-body text-center">
                    <h3 class="text-warning mb-1" id="networkDensity">0%</h3>
                    <small class="text-muted">Network Density</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-secondary">
                <div class="card-body text-center">
                    <h3 class="text-primary mb-1" id="avgConnections">0</h3>
                    <small class="text-muted">Avg Connections</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Visualization -->
    <div class="row">
        <div class="col-md-8">
            <div class="card bg-dark border-secondary">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-diagram-2 me-2"></i>Network Graph</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="layoutOptions" id="hierarchical" autocomplete="off">
                        <label class="btn btn-outline-light" for="hierarchical">Hierarchical</label>
                        
                        <input type="radio" class="btn-check" name="layoutOptions" id="force" autocomplete="off" checked>
                        <label class="btn btn-outline-light" for="force">Force</label>
                        
                        <input type="radio" class="btn-check" name="layoutOptions" id="circular" autocomplete="off">
                        <label class="btn btn-outline-light" for="circular">Circular</label>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="networkGraph" style="height: 500px; background: #1a1a1a;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Introduction Suggestions -->
            <div class="card bg-dark border-secondary mb-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-people me-2"></i>Introduction Suggestions</h5>
                </div>
                <div class="card-body">
                    <div id="introductionSuggestions">
                        <div class="text-center text-muted">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            Loading suggestions...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Network Legend -->
            <div class="card bg-dark border-secondary">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Legend</h5>
                </div>
                <div class="card-body">
                    <h6 class="text-muted mb-2">Warmth Levels:</h6>
                    <div class="mb-2">
                        <span class="badge" style="background-color: #6c757d;">Cold</span>
                        <span class="badge" style="background-color: #ffc107;">Aware</span>
                        <span class="badge" style="background-color: #fd7e14;">Warm</span>
                        <span class="badge" style="background-color: #20c997;">Active</span>
                        <span class="badge" style="background-color: #198754;">Contributor</span>
                    </div>
                    
                    <h6 class="text-muted mb-2 mt-3">Relationship Strength:</h6>
                    <div class="mb-2">
                        <div style="width: 20px; height: 1px; background: #dee2e6; display: inline-block;"></div> Weak (1)
                    </div>
                    <div class="mb-2">
                        <div style="width: 20px; height: 2px; background: #adb5bd; display: inline-block;"></div> Moderate (2-3)
                    </div>
                    <div class="mb-2">
                        <div style="width: 20px; height: 3px; background: #495057; display: inline-block;"></div> Strong (4-5)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Relationship Modal -->
<div class="modal fade" id="addRelationshipModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Add Relationship</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="relationshipForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="contactA" class="form-label">Contact A</label>
                            <select class="form-select bg-dark text-light border-secondary" id="contactA" required>
                                <option value="">Select contact...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="contactB" class="form-label">Contact B</label>
                            <select class="form-select bg-dark text-light border-secondary" id="contactB" required>
                                <option value="">Select contact...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="relationshipType" class="form-label">Relationship Type</label>
                            <select class="form-select bg-dark text-light border-secondary" id="relationshipType">
                                <option value="knows">Knows</option>
                                <option value="worked_with">Worked With</option>
                                <option value="invested_in">Invested In</option>
                                <option value="mentors">Mentors</option>
                                <option value="collaborated">Collaborated</option>
                                <option value="friends">Friends</option>
                                <option value="business_partners">Business Partners</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="strength" class="form-label">Strength (1-5)</label>
                            <select class="form-select bg-dark text-light border-secondary" id="strength">
                                <option value="1">1 - Weak</option>
                                <option value="2">2 - Casual</option>
                                <option value="3" selected>3 - Moderate</option>
                                <option value="4">4 - Strong</option>
                                <option value="5">5 - Very Strong</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control bg-dark text-light border-secondary" id="notes" rows="3" placeholder="Additional context about this relationship..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addRelationship()">Add Relationship</button>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script>
let network;
let nodes, edges;
let allContacts = [];

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    loadNetworkData();
    loadContacts();
    loadIntroductionSuggestions();
});

async function loadNetworkData() {
    try {
        const [graphResponse, metricsResponse] = await Promise.all([
            fetch('/network/api/graph'),
            fetch('/network/api/metrics')
        ]);
        
        const graphData = await graphResponse.json();
        const metricsData = await metricsResponse.json();
        
        if (graphData.status === 'success') {
            renderNetwork(graphData.data);
        }
        
        if (metricsData.status === 'success') {
            updateMetrics(metricsData.data);
        }
        
    } catch (error) {
        console.error('Error loading network data:', error);
        showAlert('Error loading network data', 'danger');
    }
}

function renderNetwork(data) {
    const container = document.getElementById('networkGraph');
    
    nodes = new vis.DataSet(data.nodes);
    edges = new vis.DataSet(data.edges);
    
    const networkData = { nodes: nodes, edges: edges };
    
    const options = {
        layout: {
            improvedLayout: true
        },
        physics: {
            enabled: true,
            stabilization: { iterations: 100 }
        },
        nodes: {
            shape: 'dot',
            font: { 
                color: '#ffffff',
                size: 12
            },
            borderWidth: 2,
            shadow: true
        },
        edges: {
            font: { 
                color: '#ffffff',
                size: 10,
                align: 'middle'
            },
            arrows: {
                to: { enabled: false }
            },
            smooth: {
                type: 'continuous'
            }
        },
        interaction: {
            hover: true,
            tooltipDelay: 200
        }
    };
    
    network = new vis.Network(container, networkData, options);
    
    // Event listeners
    network.on('click', function(params) {
        if (params.nodes.length > 0) {
            const nodeId = params.nodes[0];
            const node = nodes.get(nodeId);
            showContactDetails(node);
        }
    });
    
    // Layout change handlers
    document.querySelectorAll('input[name="layoutOptions"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updateLayout(this.id);
        });
    });
}

function updateLayout(layoutType) {
    let layoutOptions = {};
    
    switch(layoutType) {
        case 'hierarchical':
            layoutOptions = {
                layout: {
                    hierarchical: {
                        direction: 'UD',
                        sortMethod: 'directed'
                    }
                }
            };
            break;
        case 'circular':
            layoutOptions = {
                layout: {
                    randomSeed: 2
                }
            };
            break;
        default: // force
            layoutOptions = {
                layout: {
                    improvedLayout: true
                }
            };
    }
    
    network.setOptions(layoutOptions);
}

function updateMetrics(metrics) {
    document.getElementById('totalContacts').textContent = metrics.total_contacts;
    document.getElementById('totalRelationships').textContent = metrics.total_relationships;
    document.getElementById('networkDensity').textContent = metrics.network_density + '%';
    document.getElementById('avgConnections').textContent = metrics.avg_connections_per_contact;
}

async function loadContacts() {
    try {
        const response = await fetch('/api/contacts');
        const data = await response.json();
        
        if (data.status === 'success') {
            allContacts = data.contacts;
            populateContactSelects();
        }
    } catch (error) {
        console.error('Error loading contacts:', error);
    }
}

function populateContactSelects() {
    const contactASelect = document.getElementById('contactA');
    const contactBSelect = document.getElementById('contactB');
    
    // Clear existing options
    contactASelect.innerHTML = '<option value="">Select contact...</option>';
    contactBSelect.innerHTML = '<option value="">Select contact...</option>';
    
    // Add contacts
    allContacts.forEach(contact => {
        const option = `<option value="${contact.id}">${contact.name} (${contact.company || 'No company'})</option>`;
        contactASelect.innerHTML += option;
        contactBSelect.innerHTML += option;
    });
}

async function loadIntroductionSuggestions() {
    try {
        const response = await fetch('/network/api/introductions?limit=5');
        const data = await response.json();
        
        if (data.status === 'success') {
            renderIntroductionSuggestions(data.data);
        }
    } catch (error) {
        console.error('Error loading introduction suggestions:', error);
        document.getElementById('introductionSuggestions').innerHTML = 
            '<div class="text-muted">No suggestions available</div>';
    }
}

function renderIntroductionSuggestions(suggestions) {
    const container = document.getElementById('introductionSuggestions');
    
    if (suggestions.length === 0) {
        container.innerHTML = '<div class="text-muted">No introduction opportunities found</div>';
        return;
    }
    
    let html = '';
    suggestions.forEach(suggestion => {
        html += `
            <div class="mb-3 p-2 border border-secondary rounded">
                <div class="fw-bold text-light mb-1">
                    ${suggestion.contact_a} ↔ ${suggestion.contact_b}
                </div>
                <div class="small text-muted mb-1">
                    Score: ${suggestion.score} | Via: ${suggestion.mutual_connections.join(', ')}
                </div>
                <div class="small text-info">
                    ${suggestion.reason}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

async function addRelationship() {
    const form = document.getElementById('relationshipForm');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const contactA = document.getElementById('contactA').value;
    const contactB = document.getElementById('contactB').value;
    const relationshipType = document.getElementById('relationshipType').value;
    const strength = parseInt(document.getElementById('strength').value);
    const notes = document.getElementById('notes').value;
    
    if (contactA === contactB) {
        showAlert('Please select different contacts', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/network/relationships', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                contact_a_id: contactA,
                contact_b_id: contactB,
                relationship_type: relationshipType,
                strength: strength,
                notes: notes
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('Relationship added successfully', 'success');
            document.getElementById('addRelationshipModal').querySelector('.btn-close').click();
            form.reset();
            refreshNetwork();
        } else {
            showAlert('Error adding relationship: ' + data.error, 'danger');
        }
        
    } catch (error) {
        console.error('Error adding relationship:', error);
        showAlert('Error adding relationship', 'danger');
    }
}

function refreshNetwork() {
    loadNetworkData();
    loadIntroductionSuggestions();
}

function exportNetwork() {
    window.open('/network/export?format=json', '_blank');
}

function showContactDetails(node) {
    alert(`Contact: ${node.label}\nCompany: ${node.company}\nWarmth: ${node.warmth}\nConnections: ${node.interactions}`);
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const container = document.querySelector('.container');
    container.insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        const alert = container.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 5000);
}
</script>
{% endblock %}