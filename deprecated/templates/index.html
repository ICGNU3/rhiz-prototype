{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <!-- Goal-First Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-1">Your Network Today</h1>
                    <p class="text-muted mb-0">Start with a goal, find your people, act with intention</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="/goals" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-1"></i>New Goal
                    </a>
                    <a href="/contacts/add" class="btn btn-outline-secondary">
                        <i class="bi bi-person-plus me-1"></i>Add Contact
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Goal-Relevant Feed -->
    <div class="row">
        <!-- Active Goals Column -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="bi bi-bullseye me-1"></i>Active Goals</h6>
                    <span class="badge bg-primary">{{ goals|length }}</span>
                </div>
                <div class="card-body">
                    {% if goals %}
                        {% for goal in goals[:3] %}
                        <div class="d-flex align-items-start mb-3 {% if not loop.last %}border-bottom pb-3{% endif %}">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ goal.title }}</h6>
                                <p class="small text-muted mb-1">{{ goal.description[:80] }}{% if goal.description|length > 80 %}...{% endif %}</p>
                                <div class="d-flex gap-2">
                                    <a href="/goal_matcher?goal_id={{ goal.id }}" class="btn btn-sm btn-outline-primary">Find People</a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% if goals|length > 3 %}
                        <a href="/goals" class="btn btn-sm btn-link p-0">View all {{ goals|length }} goals →</a>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-3">
                            <i class="bi bi-target text-muted mb-2" style="font-size: 2rem;"></i>
                            <p class="text-muted mb-2">No goals yet</p>
                            <a href="/goals" class="btn btn-sm btn-primary">Create Your First Goal</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Relevant Contacts Column -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="bi bi-people me-1"></i>Top Contacts</h6>
                    <span class="badge bg-info">{{ contacts|length }}</span>
                </div>
                <div class="card-body">
                    {% if contacts %}
                        {% for contact in contacts[:3] %}
                        <div class="d-flex align-items-start mb-3 {% if not loop.last %}border-bottom pb-3{% endif %}">
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between">
                                    <h6 class="mb-1">{{ contact.name }}</h6>
                                    <span class="badge bg-{{ 'success' if contact.warmth == 'warm' else 'warning' if contact.warmth == 'cold' else 'secondary' }}">
                                        {{ contact.warmth|title }}
                                    </span>
                                </div>
                                <p class="small text-muted mb-1">{{ contact.company }} {% if contact.title %}• {{ contact.title }}{% endif %}</p>
                                <p class="small text-muted mb-0">{{ contact.relationship_type|title }}</p>
                            </div>
                        </div>
                        {% endfor %}
                        <a href="/contacts" class="btn btn-sm btn-link p-0">View all contacts →</a>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="bi bi-person-plus text-muted mb-2" style="font-size: 2rem;"></i>
                            <p class="text-muted mb-2">No contacts yet</p>
                            <a href="/contacts/add" class="btn btn-sm btn-secondary">Add Your First Contact</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- AI Intelligence Column -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="bi bi-robot me-1"></i>AI Insights</h6>
                    <span class="badge bg-success">Smart</span>
                </div>
                <div class="card-body">
                    {% if ai_suggestions %}
                        {% for suggestion in ai_suggestions[:3] %}
                        <div class="d-flex align-items-start mb-3 {% if not loop.last %}border-bottom pb-3{% endif %}">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ suggestion.contact_name }}</h6>
                                <p class="small text-muted mb-2">{{ suggestion.reason[:60] }}{% if suggestion.reason|length > 60 %}...{% endif %}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-light text-dark">{{ (suggestion.confidence * 100)|round }}% match</span>
                                    {% if suggestion.contact_email %}
                                    <button type="button" class="btn btn-sm btn-outline-primary" 
                                            onclick="openEmailComposer('{{ suggestion.contact_id }}', '{{ suggestion.contact_name }}', '{{ suggestion.contact_email }}', '{{ suggestion.goal_id or '' }}', '{{ suggestion.confidence }}')">
                                        <i class="bi bi-envelope me-1"></i>Send Email
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        <a href="/crm_dashboard" class="btn btn-sm btn-link p-0">View all suggestions →</a>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="bi bi-lightbulb text-muted mb-2" style="font-size: 2rem;"></i>
                            <p class="text-muted mb-2">Create goals to get AI suggestions</p>
                            <a href="/goals" class="btn btn-sm btn-success">Start with a Goal</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Network Stats Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-light border-0">
                <div class="card-body py-3">
                    <div class="row text-center">
                        <div class="col-md-3 xp-counter">
                <div class="card-body">
                    <i class="bi bi-trophy display-4 text-warning mb-2"></i>
                    <h5 class="card-title" id="user-xp">{{ user_progress.xp or 0 }}</h5>
                    <p class="card-text text-muted">{{ user_progress.title or 'Contact Seeker' }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Goals and Contacts -->
    <div class="row">
        <!-- Recent Goals -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-target me-2"></i>
                        Recent Goals
                    </h5>
                    <a href="/goals" class="btn btn-sm btn-outline-primary">
                        View All
                    </a>
                </div>
                <div class="card-body">
                    {% if goals %}
                        {% for goal in goals %}
                            <div class="d-flex justify-content-between align-items-start mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ goal.title }}</h6>
                                    <p class="text-muted small mb-1">
                                        {{ goal.description[:100] }}{% if goal.description|length > 100 %}...{% endif %}
                                    </p>
                                    <small class="text-muted">
                                        <i class="bi bi-calendar me-1"></i>
                                        {{ goal.created_at[:10] }}
                                    </small>
                                </div>
                                <a href="/match_goal/{{ goal.id }}" class="btn btn-sm btn-outline-primary ms-2">
                                    <i class="bi bi-search me-1"></i>Match
                                </a>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-target display-4 text-muted mb-3"></i>
                            <p class="text-muted">No goals yet. Create your first goal to get started!</p>
                            <a href="/goals" class="btn btn-primary">
                                <i class="bi bi-plus-lg me-1"></i>Create Goal
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Recent Contacts -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-people me-2"></i>
                        Recent Contacts
                    </h5>
                    <a href="/contacts" class="btn btn-sm btn-outline-primary">
                        View All
                    </a>
                </div>
                <div class="card-body">
                    {% if contacts %}
                        {% for contact in contacts %}
                            <div class="d-flex justify-content-between align-items-start mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ contact.name }}</h6>
                                    {% if contact.email %}
                                        <p class="text-muted small mb-1">
                                            <i class="bi bi-envelope me-1"></i>{{ contact.email }}
                                        </p>
                                    {% endif %}
                                    {% if contact.tags %}
                                        <div class="mb-1">
                                            {% for tag in contact.tags.split(',') %}
                                                <span class="badge bg-secondary me-1">{{ tag.strip() }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <small class="text-muted">
                                        <i class="bi bi-calendar me-1"></i>
                                        {{ contact.created_at[:10] }}
                                    </small>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-people display-4 text-muted mb-3"></i>
                            <p class="text-muted">No contacts yet. Add contacts to build your network!</p>
                            <a href="/contacts" class="btn btn-primary">
                                <i class="bi bi-plus-lg me-1"></i>Add Contact
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Getting Started Guide -->
    {% if not goals and not contacts %}
    <div class="row mt-5">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightbulb me-2"></i>
                        Getting Started
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="text-center">
                                <i class="bi bi-1-circle display-4 text-primary mb-2"></i>
                                <h6>Add Contacts</h6>
                                <p class="text-muted small">Build your network by adding contacts with their details and notes</p>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="text-center">
                                <i class="bi bi-2-circle display-4 text-primary mb-2"></i>
                                <h6>Create Goals</h6>
                                <p class="text-muted small">Define what you want to achieve and let AI understand your objectives</p>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="text-center">
                                <i class="bi bi-3-circle display-4 text-primary mb-2"></i>
                                <h6>Get AI Matches</h6>
                                <p class="text-muted small">Receive personalized outreach messages for the most relevant contacts</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Enhanced Email Composer Modal -->
<div class="modal fade" id="emailComposerModal" tabindex="-1" aria-labelledby="emailComposerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emailComposerModalLabel">
                    <i class="bi bi-envelope me-2"></i>Send AI-Generated Email
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="emailForm">
                    <input type="hidden" id="contactId" name="contact_id">
                    <input type="hidden" id="goalId" name="goal_id">
                    <input type="hidden" id="confidenceScore" name="confidence_score">
                    
                    <div class="mb-3">
                        <label for="recipientInfo" class="form-label">To:</label>
                        <div id="recipientInfo" class="form-control-plaintext bg-light p-2 rounded">
                            <strong id="contactName"></strong> &lt;<span id="contactEmail"></span>&gt;
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="emailSubject" class="form-label">Subject:</label>
                        <input type="text" class="form-control" id="emailSubject" name="subject" required>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label for="emailMessage" class="form-label">Message:</label>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="generateAIMessage()">
                                <i class="bi bi-robot me-1"></i>Generate AI Message
                            </button>
                        </div>
                        <textarea class="form-control" id="emailMessage" name="ai_message" rows="8" required
                                  placeholder="Your personalized message will appear here..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <div class="alert alert-info d-flex align-items-center">
                            <i class="bi bi-info-circle me-2"></i>
                            <small>This email will be sent directly using your configured email settings. Make sure to configure your email in <a href="/email_setup" target="_blank">Email Setup</a>.</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendAIEmail()" id="sendEmailBtn">
                    <i class="bi bi-send me-1"></i>Send Email
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentContactData = {};

function openEmailComposer(contactId, contactName, contactEmail, goalId, confidence) {
    currentContactData = {
        contactId: contactId,
        contactName: contactName,
        contactEmail: contactEmail,
        goalId: goalId || '',
        confidence: confidence || '0'
    };
    
    // Populate modal fields
    document.getElementById('contactId').value = contactId;
    document.getElementById('goalId').value = goalId || '';
    document.getElementById('confidenceScore').value = confidence || '0';
    document.getElementById('contactName').textContent = contactName;
    document.getElementById('contactEmail').textContent = contactEmail;
    
    // Generate default subject
    const confidencePercent = Math.round(parseFloat(confidence || 0) * 100);
    document.getElementById('emailSubject').value = `Quick introduction - ${confidencePercent}% network match`;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('emailComposerModal'));
    modal.show();
    
    // Auto-generate AI message
    setTimeout(generateAIMessage, 500);
}

async function generateAIMessage() {
    const messageTextarea = document.getElementById('emailMessage');
    const generateBtn = document.querySelector('[onclick="generateAIMessage()"]');
    
    // Show loading state
    const originalBtnText = generateBtn.innerHTML;
    generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Generating...';
    generateBtn.disabled = true;
    
    messageTextarea.value = 'Generating personalized message...';
    
    try {
        // Create a simple AI-generated message template
        const confidencePercent = Math.round(parseFloat(currentContactData.confidence) * 100);
        const aiMessage = `Hi ${currentContactData.contactName},

I hope this message finds you well. I came across your profile and was impressed by your background.

Based on our ${confidencePercent}% network compatibility match, I believe there could be valuable synergies between our respective initiatives.

I'd love to connect and explore potential collaboration opportunities. Would you be open to a brief conversation over coffee or a call in the coming weeks?

Looking forward to hearing from you.

Best regards`;
        
        messageTextarea.value = aiMessage;
        
    } catch (error) {
        messageTextarea.value = `Hi ${currentContactData.contactName},

I hope you're doing well. I'd love to connect and learn more about your work.

Would you be interested in a brief conversation to explore potential synergies?

Best regards`;
    }
    
    // Restore button state
    generateBtn.innerHTML = originalBtnText;
    generateBtn.disabled = false;
}

async function sendAIEmail() {
    const form = document.getElementById('emailForm');
    const sendBtn = document.getElementById('sendEmailBtn');
    const formData = new FormData(form);
    
    // Show loading state
    const originalBtnText = sendBtn.innerHTML;
    sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Sending...';
    sendBtn.disabled = true;
    
    try {
        const response = await fetch('/send_ai_message', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show success message
            showToast('success', `Email sent successfully to ${currentContactData.contactName}!`);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('emailComposerModal'));
            modal.hide();
            
            // Show XP earned if available
            if (result.xp_earned) {
                setTimeout(() => {
                    showToast('info', `+${result.xp_earned} XP earned for AI-assisted outreach!`);
                }, 1000);
            }
        } else {
            showToast('error', result.error || 'Failed to send email');
        }
        
    } catch (error) {
        showToast('error', 'Failed to send email. Please check your email configuration.');
    }
    
    // Restore button state
    sendBtn.innerHTML = originalBtnText;
    sendBtn.disabled = false;
}

function showToast(type, message) {
    // Create toast element
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div class="toast align-items-center text-bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0" role="alert" id="${toastId}">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Remove toast element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1055';
    document.body.appendChild(container);
    return container;
}
</script>

{% endblock %}
